"use strict";(globalThis.webpackChunkdevops_automation_site=globalThis.webpackChunkdevops_automation_site||[]).push([[8276],{2161:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>l,contentTitle:()=>t,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"13-opa-confest","title":"Lab 13 - Usando OPA com Conftest no Terraform","description":"Introdu\xe7\xe3o","source":"@site/curso-terraform-udemy/31-opa-confest.md","sourceDirName":".","slug":"/13-opa-confest","permalink":"/udemy/terraform-automacao/13-opa-confest","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":31,"frontMatter":{"id":"13-opa-confest","title":"Lab 13 - Usando OPA com Conftest no Terraform","noindex":true},"sidebar":"tutorialSidebar","previous":{"title":"Lab 12 - Introdu\xe7\xe3o ao OPA (Open Policy Agent) no Terraform","permalink":"/udemy/terraform-automacao/12-opa-teoria"},"next":{"title":"Lab 14 - Introdu\xe7\xe3o \xe0 Linguagem Rego","permalink":"/udemy/terraform-automacao/14-rego"}}');var r=n(4848),s=n(8453);const i={id:"13-opa-confest",title:"Lab 13 - Usando OPA com Conftest no Terraform",noindex:!0},t="Usando OPA com Conftest no Terraform",l={},c=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"O que \xe9 o Conftest",id:"o-que-\xe9-o-conftest",level:2},{value:"Explica\xe7\xe3o t\xe9cnica",id:"explica\xe7\xe3o-t\xe9cnica",level:2},{value:"Instala\xe7\xe3o",id:"instala\xe7\xe3o",level:2},{value:"Estrutura de arquivos",id:"estrutura-de-arquivos",level:2},{value:"Exemplo de pol\xedtica: <code>policy/deny_public_ip.rego</code>",id:"exemplo-de-pol\xedtica-policydeny_public_iprego",level:2},{value:"Gerar plan.json a partir do Terraform",id:"gerar-planjson-a-partir-do-terraform",level:2},{value:"Rodar o Conftest no plan.json",id:"rodar-o-conftest-no-planjson",level:2},{value:"Output esperado",id:"output-esperado",level:2},{value:"Outros comandos \xfateis",id:"outros-comandos-\xfateis",level:2},{value:"Melhores pr\xe1ticas",id:"melhores-pr\xe1ticas",level:2},{value:"Conclus\xe3o",id:"conclus\xe3o",level:2}];function d(e){const o={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.header,{children:(0,r.jsx)(o.h1,{id:"usando-opa-com-conftest-no-terraform",children:"Usando OPA com Conftest no Terraform"})}),"\n",(0,r.jsx)(o.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,r.jsxs)(o.p,{children:["Al\xe9m de usar o OPA diretamente com o comando ",(0,r.jsx)(o.code,{children:"opa eval"}),", \xe9 comum utilizar a ferramenta ",(0,r.jsx)(o.strong,{children:"Conftest"}),", que facilita a aplica\xe7\xe3o de pol\xedticas OPA em arquivos de configura\xe7\xe3o como os gerados pelo Terraform. Neste documento, vamos aprender como usar Conftest com arquivos Terraform e como integrar isso ao fluxo de trabalho."]}),"\n",(0,r.jsx)(o.h2,{id:"o-que-\xe9-o-conftest",children:"O que \xe9 o Conftest"}),"\n",(0,r.jsxs)(o.p,{children:["O ",(0,r.jsx)(o.strong,{children:"Conftest"})," \xe9 uma ferramenta de linha de comando que usa o OPA para validar arquivos de configura\xe7\xe3o contra pol\xedticas definidas em Rego. Ele abstrai parte da complexidade do OPA e \xe9 ideal para quem quer aplicar regras de forma simples e eficiente."]}),"\n",(0,r.jsx)(o.h2,{id:"explica\xe7\xe3o-t\xe9cnica",children:"Explica\xe7\xe3o t\xe9cnica"}),"\n",(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsx)(o.li,{children:"O Conftest interpreta arquivos JSON ou HCL convertidos em JSON"}),"\n",(0,r.jsxs)(o.li,{children:["As pol\xedticas ficam em arquivos ",(0,r.jsx)(o.code,{children:".rego"}),", dentro da pasta ",(0,r.jsx)(o.code,{children:"policy/"})]}),"\n",(0,r.jsxs)(o.li,{children:["Retorna erro se alguma regra ",(0,r.jsx)(o.code,{children:"deny"})," for acionada"]}),"\n",(0,r.jsx)(o.li,{children:"Pode ser usado localmente ou em pipelines"}),"\n"]}),"\n",(0,r.jsx)(o.h2,{id:"instala\xe7\xe3o",children:"Instala\xe7\xe3o"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"brew install conftest   # macOS\nchoco install conftest  # Windows\nscoop install conftest  # Alternativa Windows\n"})}),"\n",(0,r.jsx)(o.h2,{id:"estrutura-de-arquivos",children:"Estrutura de arquivos"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{children:"infra/\n  main.tf\n  plan.json\npolicy/\n  deny_public_ip.rego\n"})}),"\n",(0,r.jsxs)(o.h2,{id:"exemplo-de-pol\xedtica-policydeny_public_iprego",children:["Exemplo de pol\xedtica: ",(0,r.jsx)(o.code,{children:"policy/deny_public_ip.rego"})]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-rego",children:'package main\n\ndeny[msg] {\n  input.resource_changes[_].change.after.associate_public_ip_address == true\n  msg = "N\xe3o \xe9 permitido associar IP p\xfablico a inst\xe2ncias."\n}\n'})}),"\n",(0,r.jsx)(o.h2,{id:"gerar-planjson-a-partir-do-terraform",children:"Gerar plan.json a partir do Terraform"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"terraform init\nterraform plan -out=tfplan.binary\nterraform show -json tfplan.binary > plan.json\n"})}),"\n",(0,r.jsx)(o.h2,{id:"rodar-o-conftest-no-planjson",children:"Rodar o Conftest no plan.json"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"conftest test plan.json --policy policy/\n"})}),"\n",(0,r.jsx)(o.h2,{id:"output-esperado",children:"Output esperado"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"FAIL - plan.json - N\xe3o \xe9 permitido associar IP p\xfablico a inst\xe2ncias.\n\n1 test, 0 passed, 1 failed, 0 warnings\n"})}),"\n",(0,r.jsx)(o.h2,{id:"outros-comandos-\xfateis",children:"Outros comandos \xfateis"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"# Rodar com formato TAP (bom para CI)\nconftest test plan.json --policy policy/ --output tap\n\n# Rodar em todos arquivos .json\nconftest test . --policy policy/ --all-namespaces\n"})}),"\n",(0,r.jsx)(o.h2,{id:"melhores-pr\xe1ticas",children:"Melhores pr\xe1ticas"}),"\n",(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsx)(o.li,{children:"Mantenha as pol\xedticas versionadas no mesmo reposit\xf3rio do Terraform"}),"\n",(0,r.jsxs)(o.li,{children:["Use nomes descritivos nos arquivos ",(0,r.jsx)(o.code,{children:".rego"})]}),"\n",(0,r.jsxs)(o.li,{children:["Escreva mensagens claras em ",(0,r.jsx)(o.code,{children:"deny[msg]"})," para orientar o time"]}),"\n",(0,r.jsx)(o.li,{children:"Rode localmente e no CI/CD para cobertura total"}),"\n",(0,r.jsxs)(o.li,{children:["Combine com ",(0,r.jsx)(o.code,{children:"terraform fmt"}),", ",(0,r.jsx)(o.code,{children:"validate"}),", e Checkov para uma esteira completa de valida\xe7\xe3o"]}),"\n"]}),"\n",(0,r.jsx)(o.h2,{id:"conclus\xe3o",children:"Conclus\xe3o"}),"\n",(0,r.jsx)(o.p,{children:"O uso de Conftest com OPA no Terraform torna a aplica\xe7\xe3o de regras e pol\xedticas algo simples, automatizado e confi\xe1vel. Ao aplicar valida\xe7\xf5es personalizadas diretamente sobre o plano de execu\xe7\xe3o, voc\xea previne erros de seguran\xe7a e garante conformidade desde o in\xedcio do desenvolvimento."})]})}function p(e={}){const{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,r.jsx)(o,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>i,x:()=>t});var a=n(6540);const r={},s=a.createContext(r);function i(e){const o=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function t(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:o},e.children)}}}]);