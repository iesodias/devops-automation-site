"use strict";(self.webpackChunkdevops_automation_site=self.webpackChunkdevops_automation_site||[]).push([[9427],{4772:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>t,default:()=>m,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"lab-18-modulos","title":"Lab 18 - Criando uma M\xe1quina Virtual no Azure com M\xf3dulo Terraform","description":"Introdu\xe7\xe3o","source":"@site/curso-terraform-udemy/36-lab-modulos.md","sourceDirName":".","slug":"/lab-18-modulos","permalink":"/udemy/terraform-automacao/lab-18-modulos","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":36,"frontMatter":{"id":"lab-18-modulos","title":"Lab 18 - Criando uma M\xe1quina Virtual no Azure com M\xf3dulo Terraform","noindex":"trues"},"sidebar":"tutorialSidebar","previous":{"title":"Lab 17 - M\xf3dulos no Terraform","permalink":"/udemy/terraform-automacao/17-modulos-teoria"}}');var i=r(4848),s=r(8453);const o={id:"lab-18-modulos",title:"Lab 18 - Criando uma M\xe1quina Virtual no Azure com M\xf3dulo Terraform",noindex:"trues"},t="Lab: Criando uma M\xe1quina Virtual no Azure com M\xf3dulo Terraform",u={},l=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"Pr\xe9-requisitos",id:"pr\xe9-requisitos",level:2},{value:"Criar o Resource Group com Azure CLI",id:"criar-o-resource-group-com-azure-cli",level:3},{value:"Estrutura de Diret\xf3rios",id:"estrutura-de-diret\xf3rios",level:2},{value:"Estrutura esperada",id:"estrutura-esperada",level:3},{value:"Arquivo <code>main.tf</code>",id:"arquivo-maintf",level:2},{value:"Arquivo: <code>outputs.tf</code>",id:"arquivo-outputstf",level:2},{value:"Arquivo <code>variables.tf</code>",id:"arquivo-variablestf",level:2},{value:"Arquivo <code>terraform.tfvars</code>",id:"arquivo-terraformtfvars",level:2},{value:"Arquivo <code>modules/vm-linux/providers.tfvars</code>",id:"arquivo-modulesvm-linuxproviderstfvars",level:2},{value:"M\xf3dulo: <code>modules/vm-linux/main.tf</code>",id:"m\xf3dulo-modulesvm-linuxmaintf",level:2},{value:"M\xf3dulo: <code>modules/vm-linux/variables.tf</code>",id:"m\xf3dulo-modulesvm-linuxvariablestf",level:2},{value:"M\xf3dulo: <code>modules/vm-linux/outputs.tf</code>",id:"m\xf3dulo-modulesvm-linuxoutputstf",level:2},{value:"Comandos Terraform",id:"comandos-terraform",level:2},{value:"Inicializar",id:"inicializar",level:3},{value:"Planejar (usando terraform.tfvars)",id:"planejar-usando-terraformtfvars",level:3},{value:"Aplicar (usando terraform.tfvars)",id:"aplicar-usando-terraformtfvars",level:3},{value:"Destruir (usando terraform.tfvars)",id:"destruir-usando-terraformtfvars",level:3},{value:"Resultado Esperado",id:"resultado-esperado",level:2},{value:"Boas Pr\xe1ticas",id:"boas-pr\xe1ticas",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"lab-criando-uma-m\xe1quina-virtual-no-azure-com-m\xf3dulo-terraform",children:"Lab: Criando uma M\xe1quina Virtual no Azure com M\xf3dulo Terraform"})}),"\n",(0,i.jsx)(n.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,i.jsxs)(n.p,{children:["Este laborat\xf3rio demonstra como criar uma ",(0,i.jsx)(n.strong,{children:"m\xe1quina virtual Linux no Azure"})," usando um ",(0,i.jsx)(n.strong,{children:"m\xf3dulo Terraform"})," bem estruturado. Modularizar o c\xf3digo facilita a reutiliza\xe7\xe3o, manuten\xe7\xe3o e padroniza\xe7\xe3o em projetos profissionais."]}),"\n",(0,i.jsx)(n.h2,{id:"pr\xe9-requisitos",children:"Pr\xe9-requisitos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Terraform instalado (vers\xe3o >= 1.12.2)"}),"\n",(0,i.jsxs)(n.li,{children:["Azure CLI instalada e autenticada (",(0,i.jsx)(n.code,{children:"az login"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Um resource group existente no Azure"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"criar-o-resource-group-com-azure-cli",children:"Criar o Resource Group com Azure CLI"}),"\n",(0,i.jsx)(n.p,{children:"Se ainda n\xe3o existir, crie o resource group com o comando:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"az group create --name rg-devopsautomation --location eastus\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"estrutura-de-diret\xf3rios",children:"Estrutura de Diret\xf3rios"}),"\n",(0,i.jsx)(n.p,{children:"Para iniciar o projeto, execute:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir -p lab-vm-com-modulo/modules/vm-linux && cd lab-vm-com-modulo\n\ntouch main.tf variables.tf terraform.tfvars\ncd modules/vm-linux\n\ntouch main.tf variables.tf outputs.tf providers.tf\ncd ../../\n"})}),"\n",(0,i.jsx)(n.h3,{id:"estrutura-esperada",children:"Estrutura esperada"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"lab-vm-com-modulo/\n\u251c\u2500\u2500 main.tf\n\u251c\u2500\u2500 variables.tf\n\u251c\u2500\u2500 terraform.tfvars\n\u251c\u2500\u2500 modules/\n\u2502   \u2514\u2500\u2500 vm-linux/\n\u2502       \u251c\u2500\u2500 main.tf\n\u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u251c\u2500\u2500 outputs.tf\n\u2502       \u2514\u2500\u2500 providers.tf\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"arquivo-maintf",children:["Arquivo ",(0,i.jsx)(n.code,{children:"main.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'module "vm_linux" {\n  source                  = "./modules/vm-linux"\n  resource_group_name     = var.resource_group_name\n  admin_username          = var.admin_username\n  admin_password          = var.admin_password\n  location                = var.location\n  vm_name                 = var.vm_name\n  vm_size                 = var.vm_size\n  vnet_name               = var.vnet_name\n  vnet_address_space      = var.vnet_address_space\n  subnet_name             = var.subnet_name\n  subnet_prefix           = var.subnet_prefix\n  public_ip_name          = var.public_ip_name\n  nic_name                = var.nic_name\n  os_disk_name            = var.os_disk_name\n  os_disk_storage_account = var.os_disk_storage_account\n  image_offer             = var.image_offer\n  image_publisher         = var.image_publisher\n  image_sku               = var.image_sku\n  image_version           = var.image_version\n  nsg_name                = var.nsg_name\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"arquivo-outputstf",children:["Arquivo: ",(0,i.jsx)(n.code,{children:"outputs.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'output "vm_ssh_command" {\n    description = "value of the SSH command to connect to the VM"\n    value = "ssh ${var.admin_username}@${module.vm_linux.public_ip}"\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"arquivo-variablestf",children:["Arquivo ",(0,i.jsx)(n.code,{children:"variables.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'variable "resource_group_name" {\n  type = string\n}\n\nvariable "admin_username" {\n  type = string\n}\n\nvariable "admin_password" {\n  type      = string\n  sensitive = true\n}\n\nvariable "location" {\n  type = string\n}\n\nvariable "vm_name" {\n  type = string\n}\n\nvariable "vm_size" {\n  type = string\n}\n\nvariable "vnet_name" {\n  type = string\n}\n\nvariable "vnet_address_space" {\n  type = list(string)\n}\n\nvariable "subnet_name" {\n  type = string\n}\n\nvariable "subnet_prefix" {\n  type = list(string)\n}\n\nvariable "public_ip_name" {\n  type = string\n}\n\nvariable "nic_name" {\n  type = string\n}\n\nvariable "os_disk_name" {\n  type = string\n}\n\nvariable "os_disk_storage_account" {\n  type = string\n}\n\nvariable "image_publisher" {\n  type = string\n}\n\nvariable "image_offer" {\n  type = string\n}\n\nvariable "image_sku" {\n  type = string\n}\n\nvariable "image_version" {\n  type = string\n}\n\nvariable "nsg_name" {\n  type = string\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"arquivo-terraformtfvars",children:["Arquivo ",(0,i.jsx)(n.code,{children:"terraform.tfvars"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'resource_group_name     = "rg-devopsautomation"\nadmin_username          = "azureuser"\nadmin_password          = "P@ssw0rd1234!"\nlocation                = "East US"\nvm_name                 = "devopsautomation-vm"\nvm_size                 = "Standard_DS1_v2"\nvnet_name               = "devopsautomation-vnet"\nvnet_address_space      = ["10.0.0.0/16"]\nsubnet_name             = "devopsautomation-subnet"\nsubnet_prefix           = ["10.0.1.0/24"]\npublic_ip_name          = "devopsautomation-publicip"\nnic_name                = "devopsautomation-nic"\nos_disk_name            = "devopsautomation-osdisk"\nos_disk_storage_account = "Standard_LRS"\nimage_publisher         = "Canonical"\nimage_offer             = "UbuntuServer"\nimage_sku               = "18.04-LTS"\nimage_version           = "latest"\nnsg_name                = "devopsautomation-nsg"\n\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"arquivo-modulesvm-linuxproviderstfvars",children:["Arquivo ",(0,i.jsx)(n.code,{children:"modules/vm-linux/providers.tfvars"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'terraform {\n  required_providers {\n    azurerm = {\n      source  = "hashicorp/azurerm"\n      version = "4.35.0"\n    }\n  }\n\n  required_version = ">= 1.12.2"\n}\n\nprovider "azurerm" {\n  features {}\n}\n\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"m\xf3dulo-modulesvm-linuxmaintf",children:["M\xf3dulo: ",(0,i.jsx)(n.code,{children:"modules/vm-linux/main.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'data "azurerm_resource_group" "rg" {\n  name = var.resource_group_name\n}\n\nresource "azurerm_network_security_group" "nsg" {\n  name                = var.nsg_name\n  location            = var.location\n  resource_group_name = data.azurerm_resource_group.rg.name\n\n  security_rule {\n    name                       = "SSH"\n    priority                   = 1001\n    direction                  = "Inbound"\n    access                     = "Allow"\n    protocol                   = "Tcp"\n    source_port_range          = "*"\n    destination_port_range     = "22"\n    source_address_prefix      = "*"\n    destination_address_prefix = "*"\n  }\n}\n\nresource "azurerm_virtual_network" "vnet" {\n  name                = var.vnet_name\n  address_space       = var.vnet_address_space\n  location            = var.location\n  resource_group_name = data.azurerm_resource_group.rg.name\n}\n\nresource "azurerm_subnet" "subnet" {\n  name                 = var.subnet_name\n  resource_group_name  = data.azurerm_resource_group.rg.name\n  virtual_network_name = azurerm_virtual_network.vnet.name\n  address_prefixes     = var.subnet_prefix\n}\n\nresource "azurerm_public_ip" "public_ip" {\n  name                = var.public_ip_name\n  location            = var.location\n  resource_group_name = data.azurerm_resource_group.rg.name\n  allocation_method   = "Static"\n  sku                 = "Standard"\n\n}\n\nresource "azurerm_subnet_network_security_group_association" "subnet_nsg" {\n  subnet_id                 = azurerm_subnet.subnet.id\n  network_security_group_id = azurerm_network_security_group.nsg.id\n}\n\nresource "azurerm_network_interface" "nic" {\n  name                = var.nic_name\n  location            = var.location\n  resource_group_name = data.azurerm_resource_group.rg.name\n\n  ip_configuration {\n    name                          = "internal"\n    subnet_id                     = azurerm_subnet.subnet.id\n    private_ip_address_allocation = "Dynamic"\n    public_ip_address_id          = azurerm_public_ip.public_ip.id\n  }\n\n}\n\nresource "azurerm_linux_virtual_machine" "vm" {\n  name                            = var.vm_name\n  resource_group_name             = data.azurerm_resource_group.rg.name\n  location                        = var.location\n  size                            = var.vm_size\n  admin_username                  = var.admin_username\n  admin_password                  = var.admin_password\n  disable_password_authentication = false\n  network_interface_ids           = [azurerm_network_interface.nic.id]\n\n  os_disk {\n    name                 = var.os_disk_name\n    caching              = "ReadWrite"\n    storage_account_type = var.os_disk_storage_account\n  }\n\n  source_image_reference {\n    publisher = var.image_publisher\n    offer     = var.image_offer\n    sku       = var.image_sku\n    version   = var.image_version\n  }\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"m\xf3dulo-modulesvm-linuxvariablestf",children:["M\xf3dulo: ",(0,i.jsx)(n.code,{children:"modules/vm-linux/variables.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'variable "resource_group_name" {\n  type        = string\n  description = "value of the resource group name where the VM will be created"\n}\n\nvariable "admin_username" {\n  type        = string\n  description = "value of the admin username for the VM"\n}\n\nvariable "admin_password" {\n  type        = string\n  sensitive   = true\n  description = "value of the admin password for the VM"\n}\n\nvariable "location" {\n  type        = string\n  description = "value of the Azure region where the resources will be created"\n}\n\nvariable "vm_name" {\n  type        = string\n  description = "value of the VM name"\n}\n\nvariable "vm_size" {\n  type        = string\n  description = "value of the VM size"\n}\n\nvariable "vnet_name" {\n  type        = string\n  description = "value of the virtual network name"\n}\n\nvariable "vnet_address_space" {\n  type        = list(string)\n  description = "value of the virtual network address space"\n}\n\nvariable "subnet_name" {\n  type        = string\n  description = "value of the subnet name"\n}\n\nvariable "subnet_prefix" {\n  type        = list(string)\n  description = "value of the subnet prefix"\n}\n\nvariable "public_ip_name" {\n  type        = string\n  description = "value of the public IP name"\n}\n\nvariable "nic_name" {\n  type        = string\n  description = "value of the network interface name"\n}\n\nvariable "os_disk_name" {\n  type        = string\n  description = "value of the OS disk name"\n}\n\nvariable "os_disk_storage_account" {\n  type        = string\n  description = "value of the OS disk storage account type"\n}\n\nvariable "image_publisher" {\n  type        = string\n  description = "value of the image publisher for the VM"\n}\n\nvariable "image_offer" {\n  type        = string\n  description = "value of the image offer for the VM"\n}\n\nvariable "image_sku" {\n  type = string\n}\n\nvariable "image_version" {\n  type = string\n}\n\nvariable "nsg_name" {\n  type = string\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"m\xf3dulo-modulesvm-linuxoutputstf",children:["M\xf3dulo: ",(0,i.jsx)(n.code,{children:"modules/vm-linux/outputs.tf"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-terraform",children:'output "public_ip" {\n  description = "Endere\xe7o IP p\xfablico da VM"\n  value       = azurerm_public_ip.public_ip.ip_address\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"comandos-terraform",children:"Comandos Terraform"}),"\n",(0,i.jsx)(n.h3,{id:"inicializar",children:"Inicializar"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"terraform init\n"})}),"\n",(0,i.jsx)(n.h3,{id:"planejar-usando-terraformtfvars",children:"Planejar (usando terraform.tfvars)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'terraform plan -var-file="terraform.tfvars"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"aplicar-usando-terraformtfvars",children:"Aplicar (usando terraform.tfvars)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'terraform apply -var-file="terraform.tfvars"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"destruir-usando-terraformtfvars",children:"Destruir (usando terraform.tfvars)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'terraform destroy -var-file="terraform.tfvars"\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"resultado-esperado",children:"Resultado Esperado"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Cria\xe7\xe3o de uma VM Linux Ubuntu 18.04 com IP p\xfablico"}),"\n",(0,i.jsx)(n.li,{children:"Infraestrutura modularizada e parametrizada"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"boas-pr\xe1ticas",children:"Boas Pr\xe1ticas"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Sempre modularize recursos reutiliz\xe1veis"}),"\n",(0,i.jsxs)(n.li,{children:["Nunca exponha ",(0,i.jsx)(n.code,{children:"admin_password"})," em arquivos versionados"]}),"\n",(0,i.jsxs)(n.li,{children:["Use vari\xe1veis e ",(0,i.jsx)(n.code,{children:"terraform.tfvars"})," para troca de ambientes"]}),"\n",(0,i.jsx)(n.li,{children:"Combine com backend remoto para maior seguran\xe7a e colabora\xe7\xe3o"}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>t});var a=r(6540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);