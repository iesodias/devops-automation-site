"use strict";(self.webpackChunkdevops_automation_site=self.webpackChunkdevops_automation_site||[]).push([[4867],{1846:(r,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>t,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"lab-10-trivy","title":"Lab 10 - Criando uma VM com vulnerabilidades para an\xe1lise com Trivy","description":"Introdu\xe7\xe3o","source":"@site/curso-terraform-udemy/28-lab-trivy-1.md","sourceDirName":".","slug":"/lab-10-trivy","permalink":"/udemy/terraform-automacao/lab-10-trivy","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":28,"frontMatter":{"id":"lab-10-trivy","title":"Lab 10 - Criando uma VM com vulnerabilidades para an\xe1lise com Trivy","noindex":true},"sidebar":"tutorialSidebar","previous":{"title":"Aula 15 - Integra\xe7\xe3o do Checkov com GitHub Actions","permalink":"/udemy/terraform-automacao/checkov-github"},"next":{"title":"Aula 12 - Usando o Trivy com Terraform","permalink":"/udemy/terraform-automacao/trivy-teorico-1"}}');var i=n(4848),s=n(8453);const o={id:"lab-10-trivy",title:"Lab 10 - Criando uma VM com vulnerabilidades para an\xe1lise com Trivy",noindex:!0},t="Lab: Criando uma VM com vulnerabilidades para an\xe1lise com Trivy",l={},c=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"Pr\xe9-requisitos",id:"pr\xe9-requisitos",level:2},{value:"Etapas Iniciais",id:"etapas-iniciais",level:2},{value:"Arquivo: provider.tf",id:"arquivo-providertf",level:2},{value:"Arquivo: variables.tf",id:"arquivo-variablestf",level:2},{value:"Arquivo: main.tf",id:"arquivo-maintf",level:2},{value:"Arquivo: outputs.tf",id:"arquivo-outputstf",level:2},{value:"Arquivo: terraform.tfvars",id:"arquivo-terraformtfvars",level:2},{value:"Comandos Terraform",id:"comandos-terraform",level:2},{value:"Verifica\xe7\xe3o com Trivy",id:"verifica\xe7\xe3o-com-trivy",level:2},{value:"Vulnerabilidades Esperadas",id:"vulnerabilidades-esperadas",level:2},{value:"Corre\xe7\xf5es Poss\xedveis",id:"corre\xe7\xf5es-poss\xedveis",level:2},{value:"Dicas e Boas Pr\xe1ticas",id:"dicas-e-boas-pr\xe1ticas",level:2}];function d(r){const e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...r.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"lab-criando-uma-vm-com-vulnerabilidades-para-an\xe1lise-com-trivy",children:"Lab: Criando uma VM com vulnerabilidades para an\xe1lise com Trivy"})}),"\n",(0,i.jsx)(e.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,i.jsxs)(e.p,{children:["Neste laborat\xf3rio, vamos criar uma m\xe1quina virtual no Azure usando Terraform 1.12.2. O objetivo \xe9 intencionalmente inserir m\xe1s pr\xe1ticas de configura\xe7\xe3o (vulnerabilidades) para que possam ser detectadas com o ",(0,i.jsx)(e.strong,{children:"Trivy"})," e, posteriormente, corrigidas de forma simples."]}),"\n",(0,i.jsx)(e.h2,{id:"pr\xe9-requisitos",children:"Pr\xe9-requisitos"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Terraform 1.12.2 instalado"}),"\n",(0,i.jsxs)(e.li,{children:["Conta Azure autenticada com ",(0,i.jsx)(e.code,{children:"az login"})]}),"\n",(0,i.jsxs)(e.li,{children:["Trivy instalado (",(0,i.jsx)(e.a,{href:"https://aquasecurity.github.io/trivy",children:"https://aquasecurity.github.io/trivy"}),")"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"etapas-iniciais",children:"Etapas Iniciais"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Crie a estrutura do projeto:"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"mkdir lab-vm-trivy && cd lab-vm-trivy\n\ntouch main.tf variables.tf outputs.tf provider.tf terraform.tfvars\n"})}),"\n",(0,i.jsxs)(e.ol,{start:"2",children:["\n",(0,i.jsx)(e.li,{children:"Estrutura esperada:"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"lab-vm-trivy/\n\u251c\u2500\u2500 main.tf\n\u251c\u2500\u2500 outputs.tf\n\u251c\u2500\u2500 provider.tf\n\u251c\u2500\u2500 variables.tf\n\u2514\u2500\u2500 terraform.tfvars\n"})}),"\n",(0,i.jsx)(e.h2,{id:"arquivo-providertf",children:"Arquivo: provider.tf"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-terraform",children:'provider "azurerm" {\n  features {}\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"arquivo-variablestf",children:"Arquivo: variables.tf"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-terraform",children:'variable "location" {\n  default = "eastus"\n}\n\nvariable "admin_username" {\n  default = "adminuser"\n}\n\nvariable "admin_password" {\n  default = "P@ssw0rd123"  # m\xe1 pr\xe1tica: senha no c\xf3digo\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"arquivo-maintf",children:"Arquivo: main.tf"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-terraform",children:'locals {\n  prefix = "vm-trivy"\n}\n\nresource "azurerm_resource_group" "rg" {\n  name     = "${local.prefix}-rg"\n  location = var.location\n}\n\nresource "azurerm_virtual_network" "vnet" {\n  name                = "${local.prefix}-vnet"\n  address_space       = ["10.0.0.0/16"]\n  location            = var.location\n  resource_group_name = azurerm_resource_group.rg.name\n}\n\nresource "azurerm_subnet" "subnet" {\n  name                 = "default"\n  resource_group_name  = azurerm_resource_group.rg.name\n  virtual_network_name = azurerm_virtual_network.vnet.name\n  address_prefixes     = ["10.0.1.0/24"]\n}\n\nresource "azurerm_network_security_group" "nsg" {\n  name                = "${local.prefix}-nsg"\n  location            = var.location\n  resource_group_name = azurerm_resource_group.rg.name\n\n  security_rule {\n    name                       = "Allow_All_Inbound"  # m\xe1 pr\xe1tica\n    priority                   = 100\n    direction                  = "Inbound"\n    access                     = "Allow"\n    protocol                   = "*"\n    source_port_range          = "*"\n    destination_port_range     = "*"\n    source_address_prefix      = "*"\n    destination_address_prefix = "*"\n  }\n}\n\nresource "azurerm_network_interface" "nic" {\n  name                = "${local.prefix}-nic"\n  location            = var.location\n  resource_group_name = azurerm_resource_group.rg.name\n\n  ip_configuration {\n    name                          = "internal"\n    subnet_id                     = azurerm_subnet.subnet.id\n    private_ip_address_allocation = "Dynamic"\n  }\n}\n\nresource "azurerm_network_interface_security_group_association" "nsg_assoc" {\n  network_interface_id      = azurerm_network_interface.nic.id\n  network_security_group_id = azurerm_network_security_group.nsg.id\n}\n\nresource "azurerm_linux_virtual_machine" "vm" {\n  name                = "${local.prefix}-vm"\n  location            = var.location\n  resource_group_name = azurerm_resource_group.rg.name\n  size                = "Standard_B1s"\n  admin_username      = var.admin_username\n  admin_password      = var.admin_password\n  disable_password_authentication = false  # m\xe1 pr\xe1tica\n\n  network_interface_ids = [azurerm_network_interface.nic.id]\n\n  os_disk {\n    caching              = "ReadWrite"\n    storage_account_type = "Standard_LRS"\n    name                 = "osdisk"\n  }\n\n  source_image_reference {\n    publisher = "Canonical"\n    offer     = "UbuntuServer"\n    sku       = "18.04-LTS"\n    version   = "latest"\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"arquivo-outputstf",children:"Arquivo: outputs.tf"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-terraform",children:'output "vm_name" {\n  value = azurerm_linux_virtual_machine.vm.name\n}\n\noutput "nsg_name" {\n  value = azurerm_network_security_group.nsg.name\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"arquivo-terraformtfvars",children:"Arquivo: terraform.tfvars"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-hcl",children:'admin_username = "adminuser"\nadmin_password = "P@ssw0rd123"\nlocation       = "eastus"\n'})}),"\n",(0,i.jsx)(e.h2,{id:"comandos-terraform",children:"Comandos Terraform"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'terraform init\nterraform plan -var-file="terraform.tfvars"\nterraform apply -var-file="terraform.tfvars"\n'})}),"\n",(0,i.jsx)(e.h2,{id:"verifica\xe7\xe3o-com-trivy",children:"Verifica\xe7\xe3o com Trivy"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:'trivy config --tf-vars="terraform.tfvars" .\n'})}),"\n",(0,i.jsx)(e.h2,{id:"vulnerabilidades-esperadas",children:"Vulnerabilidades Esperadas"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Regra NSG permitindo ",(0,i.jsx)(e.strong,{children:"todo o tr\xe1fego inbound"})," (",(0,i.jsx)(e.code,{children:"*:*"}),")"]}),"\n",(0,i.jsxs)(e.li,{children:["Autentica\xe7\xe3o por ",(0,i.jsx)(e.strong,{children:"senha fraca embutida no c\xf3digo"})]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"corre\xe7\xf5es-poss\xedveis",children:"Corre\xe7\xf5es Poss\xedveis"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Restringir regras NSG para portas e IPs espec\xedficos"}),"\n",(0,i.jsxs)(e.li,{children:["Usar ",(0,i.jsx)(e.code,{children:"admin_ssh_key"})," e desabilitar autentica\xe7\xe3o por senha"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"dicas-e-boas-pr\xe1ticas",children:"Dicas e Boas Pr\xe1ticas"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Evite regras NSG amplas \u2014 limite por porta/IP"}),"\n",(0,i.jsx)(e.li,{children:"N\xe3o use senhas no c\xf3digo \u2014 prefira chaves SSH"}),"\n",(0,i.jsx)(e.li,{children:"Use Trivy para detectar problemas antes do apply"}),"\n"]}),"\n",(0,i.jsx)(e.hr,{})]})}function u(r={}){const{wrapper:e}={...(0,s.R)(),...r.components};return e?(0,i.jsx)(e,{...r,children:(0,i.jsx)(d,{...r})}):d(r)}},8453:(r,e,n)=>{n.d(e,{R:()=>o,x:()=>t});var a=n(6540);const i={},s=a.createContext(i);function o(r){const e=a.useContext(s);return a.useMemo((function(){return"function"==typeof r?r(e):{...e,...r}}),[e,r])}function t(r){let e;return e=r.disableParentContext?"function"==typeof r.components?r.components(i):r.components||i:o(r.components),a.createElement(s.Provider,{value:e},r.children)}}}]);