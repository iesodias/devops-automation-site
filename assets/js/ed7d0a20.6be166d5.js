"use strict";(self.webpackChunkdevops_automation_site=self.webpackChunkdevops_automation_site||[]).push([[6066],{4199:(e,r,a)=>{a.r(r),a.d(r,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>t});const o=JSON.parse('{"id":"25-lab-sentinel-tfc","title":"Lab 25 - Criando um Resource Group no Azure com Terraform Cloud (Execu\xe7\xe3o Local)","description":"Objetivo","source":"@site/curso-terraform-udemy/43-lab-terraform-cloud.md","sourceDirName":".","slug":"/25-lab-sentinel-tfc","permalink":"/udemy/terraform-automacao/25-lab-sentinel-tfc","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":43,"frontMatter":{"id":"25-lab-sentinel-tfc","title":"Lab 25 - Criando um Resource Group no Azure com Terraform Cloud (Execu\xe7\xe3o Local)","noindex":true},"sidebar":"tutorialSidebar","previous":{"title":"Lab 24 - Sentinel no Terraform Cloud","permalink":"/udemy/terraform-automacao/24-sentinel"},"next":{"title":"Projeto Final Terraform - Azure VM Infrastructure","permalink":"/udemy/terraform-automacao/99-projeto-final"}}');var n=a(4848),i=a(8453);const s={id:"25-lab-sentinel-tfc",title:"Lab 25 - Criando um Resource Group no Azure com Terraform Cloud (Execu\xe7\xe3o Local)",noindex:!0},l="Lab: Criando um Resource Group no Azure com Terraform Cloud (Execu\xe7\xe3o Local)",c={},t=[{value:"Objetivo",id:"objetivo",level:2},{value:"Requisitos",id:"requisitos",level:2},{value:"Criar Service Principal e obter credenciais (passo essencial)",id:"criar-service-principal-e-obter-credenciais-passo-essencial",level:3},{value:"Etapas do Lab",id:"etapas-do-lab",level:2},{value:"1. Criar diret\xf3rio do projeto",id:"1-criar-diret\xf3rio-do-projeto",level:3},{value:"2. Criar arquivos base",id:"2-criar-arquivos-base",level:3},{value:"3. Arquivo <code>main.tf</code>",id:"3-arquivo-maintf",level:3},{value:"4. Arquivo <code>variables.tf</code>",id:"4-arquivo-variablestf",level:3},{value:"5. Arquivo <code>terraform.tfvars</code>",id:"5-arquivo-terraformtfvars",level:3},{value:"6. Arquivo <code>outputs.tf</code>",id:"6-arquivo-outputstf",level:3},{value:"7. Criar Workspace no Terraform Cloud",id:"7-criar-workspace-no-terraform-cloud",level:2},{value:"Vari\xe1veis de Ambiente (Environment Variables)",id:"vari\xe1veis-de-ambiente-environment-variables",level:3},{value:"8. Configurar autentica\xe7\xe3o do Terraform Cloud localmente",id:"8-configurar-autentica\xe7\xe3o-do-terraform-cloud-localmente",level:2},{value:"9. Executar os comandos Terraform localmente",id:"9-executar-os-comandos-terraform-localmente",level:2},{value:"Output esperado (no terminal local)",id:"output-esperado-no-terminal-local",level:2},{value:"10. (Opcional) Criar Policy Sentinel de Teste",id:"10-opcional-criar-policy-sentinel-de-teste",level:2},{value:"Policy: <code>restrict-region.sentinel</code>",id:"policy-restrict-regionsentinel",level:3},{value:"Passos para aplicar:",id:"passos-para-aplicar",level:3},{value:"Considera\xe7\xf5es finais",id:"considera\xe7\xf5es-finais",level:2}];function d(e){const r={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"lab-criando-um-resource-group-no-azure-com-terraform-cloud-execu\xe7\xe3o-local",children:"Lab: Criando um Resource Group no Azure com Terraform Cloud (Execu\xe7\xe3o Local)"})}),"\n",(0,n.jsx)(r.h2,{id:"objetivo",children:"Objetivo"}),"\n",(0,n.jsxs)(r.p,{children:["Demonstrar como criar um ",(0,n.jsx)(r.strong,{children:"Resource Group no Azure"})," utilizando o ",(0,n.jsx)(r.strong,{children:"Terraform Cloud como backend remoto"}),", executando os comandos localmente na m\xe1quina do desenvolvedor."]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"requisitos",children:"Requisitos"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Conta no ",(0,n.jsx)(r.a,{href:"https://app.terraform.io/",children:"Terraform Cloud"})]}),"\n",(0,n.jsxs)(r.li,{children:["Azure CLI instalado e logado (",(0,n.jsx)(r.code,{children:"az login"}),")"]}),"\n",(0,n.jsx)(r.li,{children:"Token de acesso ao Azure (Service Principal)"}),"\n",(0,n.jsx)(r.li,{children:"Token de acesso ao Terraform Cloud configurado localmente"}),"\n"]}),"\n",(0,n.jsx)(r.h3,{id:"criar-service-principal-e-obter-credenciais-passo-essencial",children:"Criar Service Principal e obter credenciais (passo essencial)"}),"\n",(0,n.jsxs)(r.p,{children:["Execute o comando abaixo substituindo ",(0,n.jsx)(r.code,{children:"<sub_id>"})," pelo ID da sua assinatura Azure:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:'az ad sp create-for-rbac --name "terraform-tfc" \\\n  --role="Contributor" \\\n  --scopes="/subscriptions/<sub_id>" \\\n  --sdk-auth\n'})}),"\n",(0,n.jsx)(r.p,{children:"Copie os valores do JSON retornado e use para configurar as vari\xe1veis de ambiente no Terraform Cloud."}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"etapas-do-lab",children:"Etapas do Lab"}),"\n",(0,n.jsx)(r.h3,{id:"1-criar-diret\xf3rio-do-projeto",children:"1. Criar diret\xf3rio do projeto"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"mkdir tfc-rg-lab && cd tfc-rg-lab\n"})}),"\n",(0,n.jsx)(r.h3,{id:"2-criar-arquivos-base",children:"2. Criar arquivos base"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"touch main.tf variables.tf terraform.tfvars outputs.tf\n"})}),"\n",(0,n.jsxs)(r.h3,{id:"3-arquivo-maintf",children:["3. Arquivo ",(0,n.jsx)(r.code,{children:"main.tf"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'terraform {\n  required_providers {\n    azurerm = {\n      source  = "hashicorp/azurerm"\n      version = "~> 3.0"\n    }\n  }\n\n  cloud {\n    organization = "sua-organizacao"\n\n    workspaces {\n      name = "rg-azure-lab"\n    }\n  }\n}\n\nprovider "azurerm" {\n  features {}\n}\n\nresource "azurerm_resource_group" "rg" {\n  name     = var.resource_group_name\n  location = var.location\n}\n'})}),"\n",(0,n.jsxs)(r.h3,{id:"4-arquivo-variablestf",children:["4. Arquivo ",(0,n.jsx)(r.code,{children:"variables.tf"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'variable "resource_group_name" {\n  type = string\n}\n\nvariable "location" {\n  type = string\n}\n'})}),"\n",(0,n.jsxs)(r.h3,{id:"5-arquivo-terraformtfvars",children:["5. Arquivo ",(0,n.jsx)(r.code,{children:"terraform.tfvars"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'resource_group_name = "rg-from-tfc"\nlocation            = "eastus"\n'})}),"\n",(0,n.jsxs)(r.h3,{id:"6-arquivo-outputstf",children:["6. Arquivo ",(0,n.jsx)(r.code,{children:"outputs.tf"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'output "rg_name" {\n  value = azurerm_resource_group.rg.name\n}\n'})}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"7-criar-workspace-no-terraform-cloud",children:"7. Criar Workspace no Terraform Cloud"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["Acesse ",(0,n.jsx)(r.a,{href:"https://app.terraform.io/",children:"Terraform Cloud"})]}),"\n",(0,n.jsx)(r.li,{children:"Crie uma nova organiza\xe7\xe3o ou use uma existente"}),"\n",(0,n.jsxs)(r.li,{children:["Crie um novo ",(0,n.jsx)(r.strong,{children:"Workspace CLI-Driven"})," com o nome ",(0,n.jsx)(r.code,{children:"rg-azure-lab"})]}),"\n",(0,n.jsxs)(r.li,{children:["Na aba ",(0,n.jsx)(r.strong,{children:"Variables"}),", adicione as seguintes vari\xe1veis de ambiente:"]}),"\n"]}),"\n",(0,n.jsx)(r.h3,{id:"vari\xe1veis-de-ambiente-environment-variables",children:"Vari\xe1veis de Ambiente (Environment Variables)"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-txt",children:"ARM_CLIENT_ID        = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nARM_CLIENT_SECRET    = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nARM_SUBSCRIPTION_ID  = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\nARM_TENANT_ID        = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n"})}),"\n",(0,n.jsxs)(r.blockquote,{children:["\n",(0,n.jsxs)(r.p,{children:["Essas credenciais s\xe3o obtidas no passo anterior com ",(0,n.jsx)(r.code,{children:"az ad sp create-for-rbac"})]}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"8-configurar-autentica\xe7\xe3o-do-terraform-cloud-localmente",children:"8. Configurar autentica\xe7\xe3o do Terraform Cloud localmente"}),"\n",(0,n.jsxs)(r.p,{children:["Crie o arquivo ",(0,n.jsx)(r.code,{children:"~/.terraformrc"})," (Linux/macOS) ou ",(0,n.jsx)(r.code,{children:"%APPDATA%\\terraform.rc"})," (Windows):"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'credentials "app.terraform.io" {\n  token = "seu-token-do-terraform-cloud"\n}\n'})}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"9-executar-os-comandos-terraform-localmente",children:"9. Executar os comandos Terraform localmente"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-bash",children:"terraform init\nterraform plan -out=tfplan\nterraform apply tfplan\n"})}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"output-esperado-no-terminal-local",children:"Output esperado (no terminal local)"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-txt",children:'Apply complete! Resources: 1 added, 0 changed, 0 destroyed.\n\nOutputs:\nrg_name = "rg-from-tfc"\n'})}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"10-opcional-criar-policy-sentinel-de-teste",children:"10. (Opcional) Criar Policy Sentinel de Teste"}),"\n",(0,n.jsx)(r.p,{children:"Para testar o Sentinel com Terraform Cloud, crie a seguinte policy simples:"}),"\n",(0,n.jsxs)(r.h3,{id:"policy-restrict-regionsentinel",children:["Policy: ",(0,n.jsx)(r.code,{children:"restrict-region.sentinel"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-hcl",children:'# Importa o mock do plano do Terraform para an\xe1lise\nimport "tfplan/v2" as tfplan\n\n# Define a regi\xe3o permitida como uma vari\xe1vel local\nallowed_location = "eastus"\n\n# Encontra todos os Azure Resource Groups que est\xe3o sendo criados ou atualizados no plano\nall_resource_groups = filter tfplan.resource_changes as _, rc {\n\trc.type is "azurerm_resource_group" and\n\t\t(rc.change.actions contains "create" or rc.change.actions contains "update")\n}\n\n# Regra de valida\xe7\xe3o: Verifica se a localiza\xe7\xe3o de cada Resource Group \xe9 a permitida\nlocation_is_valid = rule {\n\tall all_resource_groups as _, rg {\n\t\trg.change.after.location is allowed_location\n\t}\n}\n\n# Regra principal (main) - O resultado desta regra determina o sucesso ou falha da policy\nmain = rule {\n\tlocation_is_valid\n}\n\n'})}),"\n",(0,n.jsx)(r.h3,{id:"passos-para-aplicar",children:"Passos para aplicar:"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["No Terraform Cloud, v\xe1 at\xe9 a organiza\xe7\xe3o \u2192 ",(0,n.jsx)(r.strong,{children:"Policies"})]}),"\n",(0,n.jsxs)(r.li,{children:["Clique em ",(0,n.jsx)(r.strong,{children:"Create Policy"}),", cole o c\xf3digo acima"]}),"\n",(0,n.jsx)(r.li,{children:"Publique a policy"}),"\n",(0,n.jsxs)(r.li,{children:["V\xe1 em ",(0,n.jsx)(r.strong,{children:"Policy Sets"})," e associe ao workspace ",(0,n.jsx)(r.code,{children:"rg-azure-lab"})]}),"\n",(0,n.jsxs)(r.li,{children:["Use enforcement ",(0,n.jsx)(r.code,{children:"advisory"})," para testes"]}),"\n"]}),"\n",(0,n.jsx)(r.hr,{}),"\n",(0,n.jsx)(r.h2,{id:"considera\xe7\xf5es-finais",children:"Considera\xe7\xf5es finais"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Utilize ",(0,n.jsx)(r.code,{children:"terraform.tfvars"})," para valores por ambiente"]}),"\n",(0,n.jsx)(r.li,{children:"O estado ser\xe1 armazenado no Terraform Cloud de forma segura"}),"\n",(0,n.jsx)(r.li,{children:"Sempre adicione vari\xe1veis sens\xedveis como secret na interface do Terraform Cloud"}),"\n",(0,n.jsxs)(r.li,{children:["O ",(0,n.jsx)(r.code,{children:"az login"})," \xe9 \xfatil localmente, mas ",(0,n.jsx)(r.strong,{children:"n\xe3o \xe9 usado pelo Terraform Cloud"}),", mesmo com execu\xe7\xe3o CLI"]}),"\n",(0,n.jsx)(r.li,{children:"Use Workspaces CLI-driven para essa abordagem h\xedbrida"}),"\n",(0,n.jsx)(r.li,{children:"O Sentinel permite implementar valida\xe7\xf5es e pol\xedticas de seguran\xe7a no fluxo de CI/CD"}),"\n"]}),"\n",(0,n.jsx)(r.p,{children:"Esse lab demonstra como usar o Terraform Cloud como backend, mantendo a execu\xe7\xe3o local. Excelente para pr\xe1ticas seguras, pol\xedticas organizacionais e prepara\xe7\xe3o para ambientes colaborativos e certifica\xe7\xf5es."})]})}function u(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},8453:(e,r,a)=>{a.d(r,{R:()=>s,x:()=>l});var o=a(6540);const n={},i=o.createContext(n);function s(e){const r=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),o.createElement(i.Provider,{value:r},e.children)}}}]);