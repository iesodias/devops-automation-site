"use strict";(self.webpackChunkdevops_automation_site=self.webpackChunkdevops_automation_site||[]).push([[7157],{6660:(e,a,r)=>{r.r(a),r.d(a,{assets:()=>t,contentTitle:()=>d,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"21-criar-vm-kevault","title":"Lab 21 - Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform","description":"Introdu\xe7\xe3o","source":"@site/curso-terraform-udemy/39-vm-keyvault.md","sourceDirName":".","slug":"/21-criar-vm-kevault","permalink":"/udemy/terraform-automacao/21-criar-vm-kevault","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":39,"frontMatter":{"id":"21-criar-vm-kevault","title":"Lab 21 - Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform","noindex":true},"sidebar":"tutorialSidebar","previous":{"title":"Lab 20 - Introdu\xe7\xe3o ao Azure Key Vault","permalink":"/udemy/terraform-automacao/20-intro-kevault"},"next":{"title":"Lab 22 - Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform","permalink":"/udemy/terraform-automacao/22-lab-kevault"}}');var n=r(4848),s=r(8453);const i={id:"21-criar-vm-kevault",title:"Lab 21 - Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform",noindex:!0},d="Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform",t={},l=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"O que \xe9",id:"o-que-\xe9",level:2},{value:"Explica\xe7\xe3o t\xe9cnica",id:"explica\xe7\xe3o-t\xe9cnica",level:2},{value:"Explicando o c\xf3digo passo a passo:",id:"explicando-o-c\xf3digo-passo-a-passo",level:3},{value:"Provider",id:"provider",level:4},{value:"Data do Key Vault",id:"data-do-key-vault",level:4},{value:"Data do segredo",id:"data-do-segredo",level:4},{value:"Uso na m\xe1quina virtual",id:"uso-na-m\xe1quina-virtual",level:4},{value:"Comandos principais",id:"comandos-principais",level:2},{value:"Estrutura de arquivos (exemplo reduzido)",id:"estrutura-de-arquivos-exemplo-reduzido",level:2},{value:"<code>main.tf</code>",id:"maintf",level:3},{value:"<code>variables.tf</code>",id:"variablestf",level:3},{value:"<code>outputs.tf</code>",id:"outputstf",level:3},{value:"<code>terraform.tfvars</code>",id:"terraformtfvars",level:3},{value:"Output esperado (simulado)",id:"output-esperado-simulado",level:2},{value:"Boas pr\xe1ticas",id:"boas-pr\xe1ticas",level:2}];function u(e){const a={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.header,{children:(0,n.jsx)(a.h1,{id:"criando-uma-m\xe1quina-virtual-no-azure-com-senha-armazenada-no-key-vault-usando-terraform",children:"Criando uma M\xe1quina Virtual no Azure com senha armazenada no Key Vault usando Terraform"})}),"\n",(0,n.jsx)(a.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,n.jsxs)(a.p,{children:["Ao trabalhar com infraestrutura como c\xf3digo, \xe9 essencial adotar boas pr\xe1ticas de seguran\xe7a desde o in\xedcio. Um erro comum \xe9 definir senhas diretamente no c\xf3digo, o que pode expor informa\xe7\xf5es sens\xedveis. Neste laborat\xf3rio, vamos aprender como provisionar uma ",(0,n.jsx)(a.strong,{children:"m\xe1quina virtual Linux no Azure"})," usando o Terraform, com a senha de administrador armazenada de forma segura no ",(0,n.jsx)(a.strong,{children:"Azure Key Vault"}),"."]}),"\n",(0,n.jsx)(a.h2,{id:"o-que-\xe9",children:"O que \xe9"}),"\n",(0,n.jsxs)(a.p,{children:["Esse lab demonstra como usar o ",(0,n.jsx)(a.strong,{children:"Azure Key Vault"})," em conjunto com o Terraform para proteger credenciais. Em vez de definir uma senha em texto plano no c\xf3digo, o segredo ser\xe1 armazenado no Key Vault, e o Terraform ir\xe1 consult\xe1-lo dinamicamente durante o provisionamento da VM."]}),"\n",(0,n.jsx)(a.h2,{id:"explica\xe7\xe3o-t\xe9cnica",children:"Explica\xe7\xe3o t\xe9cnica"}),"\n",(0,n.jsxs)(a.p,{children:["O Azure Key Vault funciona como um cofre de segredos. Nele, armazenamos dados sens\xedveis como senhas, tokens e chaves criptogr\xe1ficas. O grande diferencial aqui \xe9 que o segredo n\xe3o precisa \u2014 e ",(0,n.jsx)(a.strong,{children:"n\xe3o deve"})," \u2014 ser inserido diretamente nos arquivos ",(0,n.jsx)(a.code,{children:".tf"})," ou ",(0,n.jsx)(a.code,{children:".tfvars"}),"."]}),"\n",(0,n.jsxs)(a.p,{children:["Ao utilizar os blocos ",(0,n.jsx)(a.code,{children:"data"})," no Terraform, conseguimos consultar recursos que j\xe1 existem fora do nosso controle direto. Ou seja, podemos acessar um segredo existente no Key Vault sem cri\xe1-lo via Terraform, mantendo o princ\xedpio de separa\xe7\xe3o de responsabilidades e aumentando a seguran\xe7a."]}),"\n",(0,n.jsx)(a.h3,{id:"explicando-o-c\xf3digo-passo-a-passo",children:"Explicando o c\xf3digo passo a passo:"}),"\n",(0,n.jsx)(a.h4,{id:"provider",children:"Provider"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-hcl",children:'provider "azurerm" {\n  features {}\n}\n'})}),"\n",(0,n.jsxs)(a.p,{children:["Define o provedor do Azure. O bloco ",(0,n.jsx)(a.code,{children:"features {}"})," \xe9 necess\xe1rio para habilitar os recursos."]}),"\n",(0,n.jsx)(a.h4,{id:"data-do-key-vault",children:"Data do Key Vault"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-hcl",children:'data "azurerm_key_vault" "kv" {\n  name                = var.key_vault_name\n  resource_group_name = var.resource_group_name\n}\n'})}),"\n",(0,n.jsx)(a.p,{children:"Esse bloco n\xe3o cria o Key Vault, apenas consulta um existente com base no nome e no resource group. Isso evita que o segredo seja recriado ou sobrescrito."}),"\n",(0,n.jsx)(a.h4,{id:"data-do-segredo",children:"Data do segredo"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-hcl",children:'data "azurerm_key_vault_secret" "vm_password" {\n  name         = var.secret_name\n  key_vault_id = data.azurerm_key_vault.kv.id\n}\n'})}),"\n",(0,n.jsx)(a.p,{children:"Aqui buscamos um segredo j\xe1 criado dentro do cofre. O valor retornado \xe9 tratado como sens\xedvel automaticamente, e pode ser usado diretamente como par\xe2metro."}),"\n",(0,n.jsx)(a.h4,{id:"uso-na-m\xe1quina-virtual",children:"Uso na m\xe1quina virtual"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-hcl",children:"admin_password = data.azurerm_key_vault_secret.vm_password.value\n"})}),"\n",(0,n.jsx)(a.p,{children:"Esse \xe9 o ponto cr\xedtico: a senha \xe9 injetada diretamente no recurso da VM, sem estar declarada no c\xf3digo-fonte. O Terraform buscar\xe1 o valor em tempo de execu\xe7\xe3o."}),"\n",(0,n.jsxs)(a.blockquote,{children:["\n",(0,n.jsxs)(a.p,{children:["\u26a0\ufe0f Importante: o segredo ",(0,n.jsx)(a.strong,{children:"deve ser criado previamente"})," usando o portal ou Azure CLI, pois o Terraform s\xf3 ir\xe1 ler o segredo \u2014 n\xe3o ir\xe1 cri\xe1-lo."]}),"\n"]}),"\n",(0,n.jsx)(a.h2,{id:"comandos-principais",children:"Comandos principais"}),"\n",(0,n.jsx)(a.p,{children:"Antes de aplicar o Terraform, crie o Key Vault e adicione um segredo manualmente:"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-bash",children:'az group create --name rg-tf-vm-keyvault --location eastus\n\naz keyvault create \\\n  --name kv-tf-lab \\\n  --resource-group rg-tf-vm-keyvault \\\n  --location eastus\n\naz keyvault secret set \\\n  --vault-name kv-tf-lab \\\n  --name vmPassword \\\n  --value "SenhaSuperSegura123"\n'})}),"\n",(0,n.jsx)(a.p,{children:"Depois, aplique o Terraform normalmente:"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-bash",children:"terraform init\nterraform plan -out tfplan\nterraform apply tfplan\n"})}),"\n",(0,n.jsx)(a.h2,{id:"estrutura-de-arquivos-exemplo-reduzido",children:"Estrutura de arquivos (exemplo reduzido)"}),"\n",(0,n.jsx)(a.h3,{id:"maintf",children:(0,n.jsx)(a.code,{children:"main.tf"})}),"\n",(0,n.jsx)(a.p,{children:"Cont\xe9m os blocos para consultar o Key Vault, buscar o segredo e configurar a m\xe1quina virtual."}),"\n",(0,n.jsx)(a.h3,{id:"variablestf",children:(0,n.jsx)(a.code,{children:"variables.tf"})}),"\n",(0,n.jsx)(a.p,{children:"Define os valores esperados, como nome do vault e nome do segredo."}),"\n",(0,n.jsx)(a.h3,{id:"outputstf",children:(0,n.jsx)(a.code,{children:"outputs.tf"})}),"\n",(0,n.jsx)(a.p,{children:"Exibe, por exemplo, o IP p\xfablico da VM (sem mostrar informa\xe7\xf5es sens\xedveis)."}),"\n",(0,n.jsx)(a.h3,{id:"terraformtfvars",children:(0,n.jsx)(a.code,{children:"terraform.tfvars"})}),"\n",(0,n.jsx)(a.p,{children:"Cont\xe9m os valores atribu\xeddos \xe0s vari\xe1veis, exceto os segredos."}),"\n",(0,n.jsx)(a.h2,{id:"output-esperado-simulado",children:"Output esperado (simulado)"}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-txt",children:'Apply complete! Resources: 6 added, 0 changed, 0 destroyed.\n\nOutputs:\n\npublic_ip = "52.170.12.34"\n'})}),"\n",(0,n.jsx)(a.h2,{id:"boas-pr\xe1ticas",children:"Boas pr\xe1ticas"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsx)(a.li,{children:(0,n.jsx)(a.strong,{children:"Nunca armazene segredos no c\xf3digo-fonte."})}),"\n",(0,n.jsxs)(a.li,{children:["Use ",(0,n.jsx)(a.code,{children:"terraform.tfvars"})," apenas para dados n\xe3o sens\xedveis."]}),"\n",(0,n.jsx)(a.li,{children:"Crie e gerencie os segredos no Key Vault como uma etapa manual ou automatizada \xe0 parte."}),"\n",(0,n.jsxs)(a.li,{children:["Evite colocar o ",(0,n.jsx)(a.code,{children:"terraform.tfstate"})," em reposit\xf3rios sem criptografia."]}),"\n",(0,n.jsxs)(a.li,{children:["Marque outputs sens\xedveis com ",(0,n.jsx)(a.code,{children:"sensitive = true"}),", quando necess\xe1rio."]}),"\n",(0,n.jsxs)(a.li,{children:["Evite que a senha apare\xe7a nos logs ou outputs durante o ",(0,n.jsx)(a.code,{children:"apply"}),"."]}),"\n",(0,n.jsxs)(a.li,{children:["Prefira identidade gerenciada (Managed Identity) para dar acesso ao Key Vault, em vez de usar ",(0,n.jsx)(a.code,{children:"client_id"})," e ",(0,n.jsx)(a.code,{children:"client_secret"})," no provider."]}),"\n"]}),"\n",(0,n.jsx)(a.hr,{}),"\n",(0,n.jsx)(a.p,{children:"Esse cen\xe1rio refor\xe7a a import\xe2ncia da seguran\xe7a desde o in\xedcio. Com o Key Vault integrado ao Terraform, conseguimos separar o c\xf3digo da infraestrutura dos dados sens\xedveis, promovendo um ambiente mais seguro, audit\xe1vel e escal\xe1vel."})]})}function c(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(u,{...e})}):u(e)}},8453:(e,a,r)=>{r.d(a,{R:()=>i,x:()=>d});var o=r(6540);const n={},s=o.createContext(n);function i(e){const a=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function d(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),o.createElement(s.Provider,{value:a},e.children)}}}]);