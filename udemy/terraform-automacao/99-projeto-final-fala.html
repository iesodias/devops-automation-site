<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-terraform-automacao docs-version-current docs-doc-page docs-doc-id-99-projeto-final-fala" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Lab Final - Guia de Explicação para Gravação - Azure VM Infrastructure | Aprenda DevOps do zero com tutoriais prático</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://devopsautomation.com.br/img/devops-logo-social.png"><meta data-rh="true" name="twitter:image" content="https://devopsautomation.com.br/img/devops-logo-social.png"><meta data-rh="true" property="og:url" content="https://devopsautomation.com.br/udemy/terraform-automacao/99-projeto-final-fala"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-terraform-automacao-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-terraform-automacao-current"><meta data-rh="true" property="og:title" content="Lab Final - Guia de Explicação para Gravação - Azure VM Infrastructure | Aprenda DevOps do zero com tutoriais prático"><meta data-rh="true" name="description" content="versions.tf"><meta data-rh="true" property="og:description" content="versions.tf"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://devopsautomation.com.br/udemy/terraform-automacao/99-projeto-final-fala"><link data-rh="true" rel="alternate" href="https://devopsautomation.com.br/udemy/terraform-automacao/99-projeto-final-fala" hreflang="en"><link data-rh="true" rel="alternate" href="https://devopsautomation.com.br/udemy/terraform-automacao/99-projeto-final-fala" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aprenda DevOps do zero com tutoriais prático RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aprenda DevOps do zero com tutoriais prático Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BRH4789ZE0"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BRH4789ZE0",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.0b240cd6.css">
<script src="/assets/js/runtime~main.e74d4759.js" defer="defer"></script>
<script src="/assets/js/main.a96844f0.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo-home.png"><link rel="preload" as="image" href="/img/devops-logo.png"><link rel="preload" as="image" href="/img/logos_youtube-icon.avif"><link rel="preload" as="image" href="/img/devicon_linkedin.avif"><link rel="preload" as="image" href="/img/skill-icons_instagram.avif"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-home.png" alt="Logo DevOps Automation" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo-home.png" alt="Logo DevOps Automation" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Tutoriais</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/#cursos">Cursos</a><a href="https://youtube.com/@iesodias" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">YouTube</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/#instrutor">Instrutor</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><main class="docMainContainer_TBSr docMainContainerEnhanced_lQrH"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Projeto Final Terraform - Guia de Explicação com Comentários nos Resources</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="versionstf">versions.tf<a href="#versionstf" class="hash-link" aria-label="Direct link to versions.tf" title="Direct link to versions.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Este bloco define as versões mínimas do Terraform e dos providers necessários</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># É fundamental para garantir compatibilidade e evitar breaking changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_version = &quot;&gt;= 1.5.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  required_providers {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Provider oficial do Azure - permite criar recursos no Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azurerm = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/azurerm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 3.85&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Provider para gerar valores aleatórios - usado para nomes únicos de storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    random = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/random&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 3.6&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Provider para gerar chaves SSH automaticamente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tls = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/tls&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 4.0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Provider para recursos baseados em tempo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 0.10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Provider para recursos null (usado para triggers e dependências)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    null = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source  = &quot;hashicorp/null&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      version = &quot;~&gt; 3.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maintf">main.tf<a href="#maintf" class="hash-link" aria-label="Direct link to main.tf" title="Direct link to main.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Configuração do provider Azure com features específicas para nosso ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Essas configurações controlam comportamentos padrão do provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">provider &quot;azurerm&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  features {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource_group {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Permite deletar resource group mesmo se contiver recursos (útil para labs)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      prevent_deletion_if_contains_resources = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_machine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Remove discos automaticamente quando VM é deletada (evita custos extras)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      delete_os_disk_on_deletion     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      graceful_shutdown              = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      skip_shutdown_and_force_delete = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Data source que obtém informações da sessão atual do Azure CLI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Usado para pegar tenant_id, subscription_id e object_id automaticamente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data &quot;azurerm_client_config&quot; &quot;current&quot; {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Resource Group - container lógico que agrupa todos os recursos relacionados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Facilita organização, billing e aplicação de políticas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_resource_group&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name     = local.resource_group_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location = var.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Virtual Network - rede privada virtual no Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Define o espaço de endereços IP que nossa infraestrutura pode usar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_virtual_network&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = local.vnet_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address_space       = [var.vnet_address_space]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subnet para servidores web - segmenta a rede para melhor segurança</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Servidores web ficam isolados em sua própria subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_subnet&quot; &quot;web&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                 = local.web_subnet_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name  = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_network_name = azurerm_virtual_network.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address_prefixes     = [var.web_subnet_address_prefix]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subnet para banco de dados - isolamento adicional para dados sensíveis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Banco de dados fica em subnet separada com regras de firewall específicas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_subnet&quot; &quot;database&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                 = local.db_subnet_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name  = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_network_name = azurerm_virtual_network.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address_prefixes     = [var.db_subnet_address_prefix]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Network Security Group para subnet web - funciona como firewall de rede</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Define regras de tráfego permitido/negado para a subnet web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_network_security_group&quot; &quot;web&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = local.web_nsg_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Regra para permitir tráfego HTTP na porta 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  security_rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                       = &quot;HTTP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority                   = 1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_port_range     = &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_address_prefix      = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Regra para permitir tráfego HTTPS na porta 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  security_rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                       = &quot;HTTPS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority                   = 1002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_port_range     = &quot;443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_address_prefix      = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Regra para permitir SSH na porta 22 - restrita por IP de origem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  security_rule {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                       = &quot;SSH&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority                   = 1003</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_port_range     = &quot;22&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_address_prefix      = var.ssh_source_address_prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Associação do NSG com a subnet web - aplica as regras de firewall à subnet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_subnet_network_security_group_association&quot; &quot;web&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  subnet_id                 = azurerm_subnet.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_security_group_id = azurerm_network_security_group.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Public IPs para as VMs - usando count para criar múltiplos IPs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cada VM terá seu próprio IP público para acesso direto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_public_ip&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.public_ip_name}-${count.index + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allocation_method   = &quot;Dynamic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  domain_name_label   = &quot;${local.dns_prefix}-${count.index + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Load Balancer - recurso condicional criado apenas se há múltiplas VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Distribui tráfego entre as VMs para alta disponibilidade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_lb&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.vm_count &gt; 1 ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = local.lb_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  frontend_ip_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                 = &quot;PublicIPAddress&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_ip_address_id = azurerm_public_ip.lb[0].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Public IP para o Load Balancer - IP estático para o LB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_public_ip&quot; &quot;lb&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.vm_count &gt; 1 ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.public_ip_name}-lb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  allocation_method   = &quot;Static&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku                = &quot;Standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Network Interfaces para as VMs - conecta VMs à rede</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cada VM precisa de sua própria interface de rede</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_network_interface&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.nic_name}-${count.index + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ip_configuration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name                          = &quot;internal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subnet_id                     = azurerm_subnet.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private_ip_address_allocation = &quot;Dynamic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_ip_address_id          = var.vm_count == 1 ? azurerm_public_ip.main[count.index].id : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Geração automática de chave SSH - cria par de chaves seguro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># RSA 4096 bits para máxima segurança de acesso às VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;tls_private_key&quot; &quot;ssh&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  algorithm = &quot;RSA&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rsa_bits  = 4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ID aleatório para garantir nome único da storage account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Storage accounts precisam ter nomes globalmente únicos no Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;random_id&quot; &quot;storage_suffix&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  byte_length = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Storage Account para boot diagnostics das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Permite ver console e screenshots das VMs para troubleshooting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_storage_account&quot; &quot;boot_diagnostics&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                     = &quot;${local.storage_account_prefix}${random_id.storage_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name      = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location                 = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_tier             = &quot;Standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_replication_type = &quot;LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Key Vault para armazenar secrets de forma segura</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Centraliza gerenciamento de chaves, senhas e certificados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_key_vault&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                       = local.key_vault_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location                   = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name        = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tenant_id                  = data.azurerm_client_config.current.tenant_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku_name                   = &quot;standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  soft_delete_retention_days = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Policy de acesso para o usuário atual</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  access_policy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenant_id = data.azurerm_client_config.current.tenant_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    object_id = data.azurerm_client_config.current.object_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secret_permissions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Get&quot;, &quot;List&quot;, &quot;Set&quot;, &quot;Delete&quot;, &quot;Purge&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Armazena a chave SSH privada no Key Vault para acesso seguro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_key_vault_secret&quot; &quot;ssh_private_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name         = &quot;ssh-private-key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value        = tls_private_key.ssh.private_key_pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_vault_id = azurerm_key_vault.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Virtual Machines Linux - recurso principal da infraestrutura</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Cria VMs Ubuntu com autenticação via chave SSH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_linux_virtual_machine&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count                           = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                            = &quot;${local.vm_name}-${count.index + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location                        = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name             = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  size                            = var.vm_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  admin_username                  = var.admin_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disable_password_authentication = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_interface_ids = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azurerm_network_interface.main[count.index].id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração da chave SSH para acesso seguro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  admin_ssh_key {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username   = var.admin_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_key = tls_private_key.ssh.public_key_openssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração do disco do sistema operacional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  os_disk {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    caching              = &quot;ReadWrite&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_account_type = var.os_disk_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Especifica qual imagem usar para criar a VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_image_reference {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publisher = var.vm_image.publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offer     = var.vm_image.offer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sku       = var.vm_image.sku</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version   = var.vm_image.version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Habilita boot diagnostics para troubleshooting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  boot_diagnostics {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_account_uri = azurerm_storage_account.boot_diagnostics.primary_blob_endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  depends_on = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tls_private_key.ssh,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    azurerm_key_vault_secret.ssh_private_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = merge(local.common_tags, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name = &quot;${local.vm_name}-${count.index + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tier = &quot;Web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Managed Disks adicionais para dados - separados do disco do OS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Boa prática separar dados do sistema operacional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_managed_disk&quot; &quot;data&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count                = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                 = &quot;${local.vm_name}-${count.index + 1}-data-disk&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location             = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name  = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_account_type = &quot;Premium_LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  create_option        = &quot;Empty&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  disk_size_gb         = var.data_disk_size_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Anexa os discos de dados às VMs correspondentes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_virtual_machine_data_disk_attachment&quot; &quot;data&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count              = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  managed_disk_id    = azurerm_managed_disk.data[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_machine_id = azurerm_linux_virtual_machine.main[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lun                = &quot;10&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  caching            = &quot;ReadWrite&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="additional-resourcestf">additional-resources.tf<a href="#additional-resourcestf" class="hash-link" aria-label="Direct link to additional-resources.tf" title="Direct link to additional-resources.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Log Analytics Workspace - recurso condicional para monitoring centralizado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Só é criado se monitoring estiver habilitado na variável</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_log_analytics_workspace&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_monitoring ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = local.log_analytics_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku                 = &quot;PerGB2018&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_in_days   = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># VM Extension para instalar agente de monitoramento nas VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Coleta logs e métricas das VMs enviando para Log Analytics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_virtual_machine_extension&quot; &quot;log_analytics&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count                = var.enable_monitoring ? var.vm_count : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                 = &quot;OmsAgentForLinux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_machine_id   = azurerm_linux_virtual_machine.main[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  publisher            = &quot;Microsoft.EnterpriseCloud.Monitoring&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type                 = &quot;OmsAgentForLinux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type_handler_version = &quot;1.13&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  settings = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaceId = azurerm_log_analytics_workspace.main[0].workspace_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected_settings = jsonencode({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspaceKey = azurerm_log_analytics_workspace.main[0].primary_shared_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Recovery Services Vault - cofre para backup das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Recurso condicional criado apenas se backup estiver habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_recovery_services_vault&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_backup ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.naming_prefix}-rsv&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku                 = &quot;Standard&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  soft_delete_enabled = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Política de backup para as VMs - define quando e como fazer backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_backup_policy_vm&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_backup ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.naming_prefix}-backup-policy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  recovery_vault_name = azurerm_recovery_services_vault.main[0].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backup {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    frequency = &quot;Daily&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time      = &quot;23:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Retenção diária dos backups</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_daily {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count = var.backup_retention_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Retenção semanal - mantém backup de domingo por 4 semanas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_weekly {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count    = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weekdays = [&quot;Sunday&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Retenção mensal - mantém backup do primeiro domingo por 12 meses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retention_monthly {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count    = 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weekdays = [&quot;Sunday&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weeks    = [&quot;First&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Proteção de backup aplicada às VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Liga cada VM à política de backup criada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_backup_protected_vm&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_backup ? var.vm_count : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  recovery_vault_name = azurerm_recovery_services_vault.main[0].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  source_vm_id        = azurerm_linux_virtual_machine.main[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backup_policy_id    = azurerm_backup_policy_vm.main[0].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Auto-shutdown das VMs - desliga automaticamente para economizar custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Especialmente útil em ambientes de desenvolvimento e teste</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_dev_test_global_vm_shutdown_schedule&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count              = local.should_enable_auto_shutdown ? var.vm_count : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_machine_id = azurerm_linux_virtual_machine.main[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location           = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enabled            = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  daily_recurrence_time = var.auto_shutdown_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timezone              = var.auto_shutdown_timezone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configurações de notificação antes do shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  notification_settings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled         = var.notification_email != &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time_in_minutes = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email           = var.notification_email != &quot;&quot; ? var.notification_email : &quot;noreply@example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Application Security Group - agrupa VMs logicamente para regras de firewall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Facilita aplicação de regras de segurança baseadas em função</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_application_security_group&quot; &quot;web&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.naming_prefix}-asg-web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location            = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Associa as NICs das VMs ao Application Security Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_network_interface_application_security_group_association&quot; &quot;web&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count                         = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_interface_id          = azurerm_network_interface.main[count.index].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  application_security_group_id = azurerm_application_security_group.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Action Group para alertas do Azure Monitor - define quem recebe alertas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_monitor_action_group&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_monitoring ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${local.naming_prefix}-actiongroup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  short_name          = &quot;webapp-ag&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Destinatário de email para alertas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  email_receiver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name          = &quot;admin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    email_address = &quot;admin@empresa.com.br&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Alerta de CPU alta - monitora uso de CPU das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Dispara alerta quando CPU passa de 80% por período prolongado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_monitor_metric_alert&quot; &quot;cpu_high&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count               = var.enable_monitoring ? var.vm_count : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${azurerm_linux_virtual_machine.main[count.index].name}-cpu-alert&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scopes              = [azurerm_linux_virtual_machine.main[count.index].id]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description         = &quot;Alert when CPU usage is over 80%&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  severity            = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Critério do alerta - CPU média maior que 80%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  criteria {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric_namespace = &quot;Microsoft.Compute/virtualMachines&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metric_name      = &quot;Percentage CPU&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aggregation      = &quot;Average&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operator         = &quot;GreaterThan&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threshold        = 80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Ação a tomar quando alerta é disparado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  action {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    action_group_id = azurerm_monitor_action_group.main[0].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Availability Set - garante alta disponibilidade para múltiplas VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Distribui VMs entre diferentes racks e domínios de atualização</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_availability_set&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  count                        = var.vm_count &gt; 1 ? 1 : 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                         = &quot;${local.naming_prefix}-avset&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location                     = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name          = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  platform_fault_domain_count  = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  platform_update_domain_count = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  managed                      = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Private DNS Zone - resolução de nomes interna para VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Permite usar nomes amigáveis em vez de IPs para comunicação interna</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_private_dns_zone&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                = &quot;${var.project_name}.local&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Link da Private DNS Zone com a VNet - habilita resolução DNS automática</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resource &quot;azurerm_private_dns_zone_virtual_network_link&quot; &quot;main&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name                  = &quot;${local.naming_prefix}-dns-link&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name   = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private_dns_zone_name = azurerm_private_dns_zone.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  virtual_network_id    = azurerm_virtual_network.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  registration_enabled  = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tags = local.common_tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="variablestf">variables.tf<a href="#variablestf" class="hash-link" aria-label="Direct link to variables.tf" title="Direct link to variables.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Variável para nome do projeto - será usada como prefixo em todos os recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Validação garante apenas letras minúsculas e números para compatibilidade com Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;project_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome do projeto que será usado como prefixo para recursos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;webapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(regex(&quot;^[a-z0-9]+$&quot;, var.project_name))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Project name deve conter apenas letras minúsculas e números.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Variável de ambiente - controla configurações específicas por ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Aceita apenas valores predefinidos para evitar erros de configuração</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;environment&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Environment (dev, staging, prod)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = contains([&quot;dev&quot;, &quot;staging&quot;, &quot;prod&quot;], var.environment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Environment deve ser: dev, staging, ou prod.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Região Azure onde todos os recursos serão criados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista pré-aprovada de regiões para controlar custos e compliance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;location&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Azure region onde os recursos serão criados&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;Brazil South&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = contains([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Brazil South&quot;, &quot;East US&quot;, &quot;East US 2&quot;, &quot;West US&quot;, &quot;West US 2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Central US&quot;, &quot;North Central US&quot;, &quot;South Central US&quot;, &quot;West Central US&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Canada Central&quot;, &quot;Canada East&quot;, &quot;West Europe&quot;, &quot;North Europe&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;UK South&quot;, &quot;UK West&quot;, &quot;France Central&quot;, &quot;Germany West Central&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Switzerland North&quot;, &quot;Norway East&quot;, &quot;Sweden Central&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ], var.location)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Location deve ser uma região Azure válida.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Número de VMs a serem criadas - usado com count em múltiplos recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Limitado entre 1-5 para evitar custos excessivos em labs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;vm_count&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Número de VMs a serem criadas&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = var.vm_count &gt;= 1 &amp;&amp; var.vm_count &lt;= 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;VM count deve estar entre 1 e 5.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tamanho (SKU) das VMs - define CPU, RAM e performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista restrita de tamanhos aprovados para controlar custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;vm_size&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Tamanho da VM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;Standard_B2s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = contains([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Standard_B1s&quot;, &quot;Standard_B1ms&quot;, &quot;Standard_B2s&quot;, &quot;Standard_B2ms&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Standard_B4ms&quot;, &quot;Standard_D2s_v3&quot;, &quot;Standard_D4s_v3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Standard_F2s_v2&quot;, &quot;Standard_F4s_v2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ], var.vm_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;VM size deve ser um dos tamanhos aprovados.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Nome do usuário administrativo das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Validação garante formato correto (3-20 caracteres, inicia com letra)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;admin_username&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome de usuário administrativo para as VMs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;azureuser&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(regex(&quot;^[a-z][a-z0-9]{2,19}$&quot;, var.admin_username))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Admin username deve começar com letra minúscula e ter entre 3-20 caracteres.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tipo de disco para o sistema operacional - afeta performance e custo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Opções: Standard (HDD), StandardSSD, Premium (SSD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;os_disk_type&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Tipo do disco do OS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;Premium_LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = contains([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Standard_LRS&quot;, &quot;StandardSSD_LRS&quot;, &quot;Premium_LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ], var.os_disk_type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;OS disk type deve ser: Standard_LRS, StandardSSD_LRS, ou Premium_LRS.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tamanho do disco de dados adicional em GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Separado do disco do OS para melhor organização e performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;data_disk_size_gb&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Tamanho do disco de dados em GB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = var.data_disk_size_gb &gt;= 32 &amp;&amp; var.data_disk_size_gb &lt;= 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Data disk size deve estar entre 32GB e 1024GB.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CIDR da Virtual Network - define range de IPs da rede privada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Deve ser RFC 1918 (10.x, 172.16-31.x, 192.168.x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;vnet_address_space&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Address space para a VNet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;10.0.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(cidrhost(var.vnet_address_space, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;VNet address space deve ser um CIDR válido.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CIDR da subnet para servidores web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Deve estar contido dentro do address_space da VNet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;web_subnet_address_prefix&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Address prefix para a subnet web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;10.0.1.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(cidrhost(var.web_subnet_address_prefix, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Web subnet address prefix deve ser um CIDR válido.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CIDR da subnet para banco de dados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Isolamento de rede para maior segurança dos dados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;db_subnet_address_prefix&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Address prefix para a subnet de banco de dados&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;10.0.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(cidrhost(var.db_subnet_address_prefix, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;DB subnet address prefix deve ser um CIDR válido.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Range de IPs permitidos para acesso SSH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Pode ser CIDR específico ou &quot;*&quot; para qualquer IP (não recomendado para prod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;ssh_source_address_prefix&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Source address prefix permitido para SSH&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = can(cidrhost(var.ssh_source_address_prefix, 0)) || var.ssh_source_address_prefix == &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;SSH source address prefix deve ser um CIDR válido ou &#x27;*&#x27;.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Objeto complexo que define qual imagem de VM usar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Especifica publisher, offer, sku e version da imagem do Azure Marketplace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;vm_image&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Imagem da VM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = object({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publisher = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offer     = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sku       = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version   = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    publisher = &quot;Canonical&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    offer     = &quot;0001-com-ubuntu-server-focal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sku       = &quot;20_04-lts-gen2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    version   = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tags personalizadas para recursos - importante para billing e governança</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Validação garante formato correto das chaves das tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;tags&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Tags adicionais para aplicar aos recursos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = map(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = alltrue([for k, v in var.tags : can(regex(&quot;^[a-zA-Z0-9_.-]+$&quot;, k))])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Tag keys devem conter apenas letras, números, hífens, underscores e pontos.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Flag para habilitar backup das VMs - recursos condicionais</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Controla criação do Recovery Services Vault e políticas de backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;enable_backup&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Habilitar backup das VMs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Período de retenção dos backups em dias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Afeta custos de armazenamento - maior retenção = maior custo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;backup_retention_days&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Número de dias para retenção de backup&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = var.backup_retention_days &gt;= 7 &amp;&amp; var.backup_retention_days &lt;= 365</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Backup retention deve estar entre 7 e 365 dias.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Flag para habilitar monitoring com Log Analytics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Controla criação do workspace e instalação de agentes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;enable_monitoring&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Habilitar monitoring com Log Analytics&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Horário para auto-shutdown das VMs em formato 24h (HHMM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Crucial para economizar custos em ambientes de desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;auto_shutdown_time&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Horário para auto shutdown das VMs (formato 24h: HHMM)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;1800&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition     = can(regex(&quot;^([01]?[0-9]|2[0-3])[0-5][0-9]$&quot;, var.auto_shutdown_time))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Auto shutdown time deve estar no formato HHMM (ex: 1800 para 18:00).&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Timezone para o auto-shutdown - importante para horário correto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;auto_shutdown_timezone&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Timezone para auto shutdown&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;E. South America Standard Time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Email para receber notificações de auto-shutdown (opcional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Se vazio, notificações são desabilitadas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;notification_email&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Email para receber notificações de auto-shutdown (opcional)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = var.notification_email == &quot;&quot; || can(regex(&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$&quot;, var.notification_email))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Notification email deve ser um email válido ou string vazia.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista de CIDRs permitidos para SSH - alternativa mais granular ao ssh_source_address_prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Permite múltiplos ranges (ex: rede corporativa + VPN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">variable &quot;allowed_ssh_cidrs&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Lista de CIDRs permitidos para acesso SSH&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type        = list(string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default     = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validation {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition = alltrue([</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for cidr in var.allowed_ssh_cidrs : can(cidrhost(cidr, 0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    error_message = &quot;Todos os CIDRs devem ser válidos.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="localstf">locals.tf<a href="#localstf" class="hash-link" aria-label="Direct link to locals.tf" title="Direct link to locals.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">locals {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Prefixo padrão para nomenclatura de recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Combina nome do projeto + ambiente (ex: webapp-dev)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  naming_prefix = &quot;${var.project_name}-${var.environment}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Nomes padronizados de recursos seguindo convenção {projeto}-{ambiente}-{tipo}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Centralizado para facilitar mudanças e manter consistência</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource_group_name    = &quot;${local.naming_prefix}-rg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vnet_name             = &quot;${local.naming_prefix}-vnet&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  web_subnet_name       = &quot;${local.naming_prefix}-subnet-web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  db_subnet_name        = &quot;${local.naming_prefix}-subnet-db&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  web_nsg_name          = &quot;${local.naming_prefix}-nsg-web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  db_nsg_name           = &quot;${local.naming_prefix}-nsg-db&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public_ip_name        = &quot;${local.naming_prefix}-pip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nic_name              = &quot;${local.naming_prefix}-nic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vm_name               = &quot;${local.naming_prefix}-vm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lb_name               = &quot;${local.naming_prefix}-lb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_vault_name        = &quot;${local.naming_prefix}-kv-${random_id.storage_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  log_analytics_name    = &quot;${local.naming_prefix}-law&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Nome da storage account sem hífens (limitação do Azure)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Combina projeto + ambiente + sufixo aleatório para uniqueness global</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storage_account_prefix = replace(&quot;${var.project_name}${var.environment}diag&quot;, &quot;-&quot;, &quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Prefixo DNS para Public IPs - deve ser globalmente único</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Inclui sufixo aleatório para evitar conflitos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dns_prefix = &quot;${var.project_name}${var.environment}${random_id.storage_suffix.hex}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Tags comuns aplicadas a todos os recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Merge combina tags padrão com tags personalizadas do usuário</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  common_tags = merge({</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Project     = var.project_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Environment = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ManagedBy   = &quot;Terraform&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CreatedBy   = &quot;TerraformProject&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CreatedOn   = formatdate(&quot;YYYY-MM-DD&quot;, timestamp())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner       = &quot;DevOps Team&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CostCenter  = &quot;IT-Infrastructure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Backup      = var.enable_backup ? &quot;Enabled&quot; : &quot;Disabled&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Monitoring  = var.enable_monitoring ? &quot;Enabled&quot; : &quot;Disabled&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }, var.tags)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração de rede centralizada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Facilita referência e possíveis mudanças futuras</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vnet_address_space         = var.vnet_address_space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    web_subnet_address_prefix  = var.web_subnet_address_prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db_subnet_address_prefix   = var.db_subnet_address_prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dns_servers               = [&quot;168.63.129.16&quot;] # Azure DNS padrão</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configurações específicas por ambiente para otimização de custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Define tamanhos e features apropriados para cada ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  vm_config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dev = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      size                = &quot;Standard_B1s&quot;      # VM pequena para dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      os_disk_type       = &quot;Standard_LRS&quot;      # Disco mais barato</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      data_disk_size_gb  = 32                  # Disco menor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable_backup      = false               # Sem backup para economizar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_shutdown      = true                # Auto-shutdown habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    staging = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      size                = &quot;Standard_B2s&quot;      # VM média para staging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      os_disk_type       = &quot;StandardSSD_LRS&quot;   # SSD padrão</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      data_disk_size_gb  = 64                  # Disco médio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable_backup      = true                # Backup habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_shutdown      = true                # Auto-shutdown habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prod = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      size                = &quot;Standard_D2s_v3&quot;   # VM robusta para prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      os_disk_type       = &quot;Premium_LRS&quot;       # SSD premium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      data_disk_size_gb  = 128                 # Disco maior</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enable_backup      = true                # Backup obrigatório</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      auto_shutdown      = false               # Sem auto-shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Valores efetivos baseados no ambiente atual</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Se variável não foi alterada, usa configuração do ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  effective_vm_size = var.vm_size != &quot;Standard_B2s&quot; ? var.vm_size : local.vm_config[var.environment].size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  effective_os_disk_type = var.os_disk_type != &quot;Premium_LRS&quot; ? var.os_disk_type : local.vm_config[var.environment].os_disk_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  effective_data_disk_size = var.data_disk_size_gb != 64 ? var.data_disk_size_gb : local.vm_config[var.environment].data_disk_size_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Regras de segurança para tráfego web (HTTP/HTTPS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Array de objetos que define regras padrão para servidores web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  web_security_rules = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name                       = &quot;HTTP&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priority                   = 1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_port_range     = &quot;80&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_address_prefix      = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name                       = &quot;HTTPS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priority                   = 1002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_port_range     = &quot;443&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_address_prefix      = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Regras de SSH dinâmicas - uma para cada CIDR permitido</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # For expression cria regras com prioridades incrementais</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ssh_security_rules = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for i, cidr in var.allowed_ssh_cidrs : {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name                       = &quot;SSH-${i + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priority                   = 1100 + i        # Prioridades: 1100, 1101, 1102...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      direction                  = &quot;Inbound&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      access                     = &quot;Allow&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol                   = &quot;Tcp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_port_range          = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_port_range     = &quot;22&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source_address_prefix      = cidr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Todas as regras de segurança combinadas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Concat junta arrays de regras web + SSH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  all_security_rules = concat(local.web_security_rules, local.ssh_security_rules)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração de backup condicional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Só define configuração se backup estiver habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  backup_config = var.enable_backup ? {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    policy_name           = &quot;${local.naming_prefix}-backup-policy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vault_name           = &quot;${local.naming_prefix}-rsv&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retention_daily      = var.backup_retention_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retention_weekly     = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retention_monthly    = 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retention_yearly     = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup_time         = &quot;23:00&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup_timezone     = var.auto_shutdown_timezone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração de monitoring condicional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Define parâmetros do Log Analytics se monitoring habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  monitoring_config = var.enable_monitoring ? {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    workspace_name       = local.log_analytics_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    retention_days      = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sku                 = &quot;PerGB2018&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    solutions = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;VMInsights&quot;,    # Insights de VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Security&quot;,      # Security Center</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;Updates&quot;        # Update Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração de auto-shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Combina configuração do ambiente com variáveis do usuário</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auto_shutdown_config = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enabled          = local.vm_config[var.environment].auto_shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time            = var.auto_shutdown_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timezone        = var.auto_shutdown_timezone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    notification_settings = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled         = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      time_in_minutes = 30                # Notifica 30min antes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      webhook_url     = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      email_recipient = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Flags condicionais para criação de recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Determinam quais recursos opcionais criar baseado em lógica</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  should_create_load_balancer = var.vm_count &gt; 1                                      # LB só com múltiplas VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  should_create_backup = var.enable_backup &amp;&amp; local.vm_config[var.environment].enable_backup  # Backup habilitado + config do ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  should_create_monitoring = var.enable_monitoring                                     # Monitoring se habilitado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  should_enable_auto_shutdown = local.auto_shutdown_config.enabled                    # Auto-shutdown baseado no ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Mapeamento de regiões Azure para códigos curtos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Usado para nomenclatura quando região faz parte do nome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location_short = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Brazil South&quot;              = &quot;brs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;East US&quot;                   = &quot;eus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;East US 2&quot;                 = &quot;eus2&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;West US&quot;                   = &quot;wus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;West US 2&quot;                 = &quot;wus2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Central US&quot;                = &quot;cus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;North Central US&quot;          = &quot;ncus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;South Central US&quot;          = &quot;scus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;West Central US&quot;           = &quot;wcus&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Canada Central&quot;            = &quot;cac&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Canada East&quot;               = &quot;cae&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;West Europe&quot;               = &quot;weu&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;North Europe&quot;              = &quot;neu&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;UK South&quot;                  = &quot;uks&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;UK West&quot;                   = &quot;ukw&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;France Central&quot;            = &quot;frc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Germany West Central&quot;      = &quot;gwc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Switzerland North&quot;         = &quot;swn&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Norway East&quot;               = &quot;noe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;Sweden Central&quot;            = &quot;sec&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Sufixo da localização para nomenclatura</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  location_suffix = lookup(local.location_short, var.location, &quot;unknown&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Nomenclatura avançada incluindo localização</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Para recursos que precisam indicar região no nome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  advanced_naming = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource_group    = &quot;${local.naming_prefix}-${local.location_suffix}-rg&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_account   = lower(replace(&quot;${var.project_name}${var.environment}${local.location_suffix}sa${random_id.storage_suffix.hex}&quot;, &quot;-&quot;, &quot;&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key_vault        = &quot;${local.naming_prefix}-${local.location_suffix}-kv&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Configuração de Network ACLs para storage accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Produção nega acesso por padrão, outros ambientes permitem tudo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  network_acls = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default_action = &quot;Deny&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_rules = var.environment == &quot;prod&quot; ? [] : [&quot;0.0.0.0/0&quot;]  # Prod sem IPs permitidos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_network_subnet_ids = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Será preenchido após criação das subnets se necessário</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="outputstf">outputs.tf<a href="#outputstf" class="hash-link" aria-label="Direct link to outputs.tf" title="Direct link to outputs.tf">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Informações básicas do Resource Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Nome do container lógico que agrupa todos os recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;resource_group_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome do Resource Group criado&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Localização onde os recursos foram criados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;resource_group_location&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Localização do Resource Group&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_resource_group.main.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ID único do Resource Group no Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;resource_group_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;ID do Resource Group&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_resource_group.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações da rede virtual criada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Nome da VNet para referência em outros scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;virtual_network_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome da Virtual Network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_virtual_network.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ID da VNet para uso em associações e políticas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;virtual_network_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;ID da Virtual Network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_virtual_network.main.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Espaço de endereços da VNet para documentação e troubleshooting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;virtual_network_address_space&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Address space da Virtual Network&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_virtual_network.main.address_space</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IDs das subnets para conexão de recursos futuros</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;web_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;ID da subnet web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_subnet.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;database_subnet_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;ID da subnet database&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_subnet.database.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações das VMs criadas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista com nomes de todas as VMs para administração</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;vm_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nomes das VMs criadas&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_linux_virtual_machine.main[*].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IDs das VMs para uso em scripts de automação</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;vm_ids&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;IDs das VMs criadas&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_linux_virtual_machine.main[*].id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IPs privados das VMs para comunicação interna</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># For expression extrai IP de cada network interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;vm_private_ip_addresses&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Endereços IP privados das VMs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for nic in azurerm_network_interface.main :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nic.ip_configuration[0].private_ip_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IPs públicos das VMs para acesso externo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista de IPs para conexão SSH e acesso web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;vm_public_ip_addresses&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Endereços IP públicos das VMs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pip in azurerm_public_ip.main :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pip.ip_address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># FQDNs (nomes DNS completos) das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># URLs amigáveis para acesso às VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;vm_fqdns&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;FQDNs das VMs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pip in azurerm_public_ip.main :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pip.fqdn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações do Load Balancer (quando aplicável)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IP público do LB se múltiplas VMs foram criadas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;load_balancer_public_ip&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;IP público do Load Balancer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = var.vm_count &gt; 1 ? azurerm_public_ip.lb[0].ip_address : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># FQDN do Load Balancer para acesso web balanceado</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;load_balancer_fqdn&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;FQDN do Load Balancer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = var.vm_count &gt; 1 ? azurerm_public_ip.lb[0].fqdn : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Chave SSH privada para acesso às VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Marcada como sensitive para não aparecer em logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;ssh_private_key_pem&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Chave SSH privada em formato PEM&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = tls_private_key.ssh.private_key_pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sensitive   = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Chave SSH pública para referência e backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;ssh_public_key&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Chave SSH pública&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = tls_private_key.ssh.public_key_openssh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações da Storage Account para boot diagnostics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;boot_diagnostics_storage_account_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome da Storage Account para boot diagnostics&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_storage_account.boot_diagnostics.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Endpoint da storage account para configurações adicionais</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;boot_diagnostics_storage_account_primary_endpoint&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Endpoint primário da Storage Account&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_storage_account.boot_diagnostics.primary_blob_endpoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações do Key Vault para acesso a secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;key_vault_name&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nome do Key Vault&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_key_vault.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># URI do Key Vault para integração com aplicações</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;key_vault_uri&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;URI do Key Vault&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_key_vault.main.vault_uri</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações dos discos de dados adicionais</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;data_disk_names&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Nomes dos discos de dados&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_managed_disk.data[*].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tamanhos dos discos para planejamento de capacidade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;data_disk_sizes&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Tamanhos dos discos de dados em GB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_managed_disk.data[*].disk_size_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações do Network Security Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;web_nsg_id&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;ID do Network Security Group web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value       = azurerm_network_security_group.web.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Regras de segurança aplicadas para auditoria</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># For expression formata regras de forma legível</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;web_nsg_security_rules&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Regras de segurança do NSG web&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for rule in azurerm_network_security_group.web.security_rule :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name                   = rule.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priority               = rule.priority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      direction              = rule.direction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      access                 = rule.access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      protocol               = rule.protocol</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination_port_range = rule.destination_port_range</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Resumo completo do deployment para documentação</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Objeto com todas as informações principais</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;deployment_summary&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Resumo do deployment&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    project_name          = var.project_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment           = var.environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location              = var.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vm_count              = var.vm_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vm_size               = local.effective_vm_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resource_group        = azurerm_resource_group.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    virtual_network       = azurerm_virtual_network.main.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_balancer_enabled = var.vm_count &gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backup_enabled        = var.enable_backup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    monitoring_enabled    = var.enable_monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total_data_disk_gb    = sum(azurerm_managed_disk.data[*].disk_size_gb)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    creation_date         = formatdate(&quot;YYYY-MM-DD hh:mm:ss ZZZ&quot;, timestamp())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações para estimativa de custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Dados estruturados para cálculos de billing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;cost_estimation_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Informações para estimativa de custos&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region = var.location</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vms = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for i in range(var.vm_count) : {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name           = azurerm_linux_virtual_machine.main[i].name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size           = azurerm_linux_virtual_machine.main[i].size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os_disk_type   = azurerm_linux_virtual_machine.main[i].os_disk[0].storage_account_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data_disk_type = azurerm_managed_disk.data[i].storage_account_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data_disk_size = azurerm_managed_disk.data[i].disk_size_gb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_accounts = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name         = azurerm_storage_account.boot_diagnostics.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        account_tier = azurerm_storage_account.boot_diagnostics.account_tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        replication  = azurerm_storage_account.boot_diagnostics.account_replication_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_ips    = length(azurerm_public_ip.main) + (var.vm_count &gt; 1 ? 1 : 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_balancer = var.vm_count &gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações de conexão SSH prontas para uso</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Comandos formatados para conexão imediata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;connection_info&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Informações de conexão SSH&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username = var.admin_username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ssh_command = var.vm_count == 1 ? [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;ssh -i private_key.pem ${var.admin_username}@${azurerm_public_ip.main[0].ip_address}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ] : [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for i, pip in azurerm_public_ip.main :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;ssh -i private_key.pem ${var.admin_username}@${pip.ip_address} # VM ${i + 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Informações de DNS para acesso amigável</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output &quot;dns_information&quot; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  description = &quot;Informações de DNS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  value = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public_dns_names = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      for pip in azurerm_public_ip.main :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pip.fqdn if pip.fqdn != null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_balancer_dns = var.vm_count &gt; 1 ? azurerm_public_ip.lb[0].fqdn : null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="terraformtfvars">terraform.tfvars<a href="#terraformtfvars" class="hash-link" aria-label="Direct link to terraform.tfvars" title="Direct link to terraform.tfvars">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># terraform.tfvars - Configuração principal do projeto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Este arquivo contém os valores padrão para todas as variáveis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO BÁSICA DO PROJETO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Nome do projeto usado como prefixo em todos os recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project_name = &quot;webapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ambiente de deployment - controla configurações específicas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment  = &quot;dev&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Região Azure onde criar todos os recursos - impacta latência e custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location     = &quot;Brazil South&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO DAS VIRTUAL MACHINES ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Número de VMs a criar - usando 2 para demonstrar load balancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_count          = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tamanho da VM - Standard_B2s é boa opção custo-benefício para testes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_size           = &quot;Standard_B2s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Nome do usuário administrativo das VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_username    = &quot;azureuser&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tipo do disco do sistema operacional - Premium para melhor performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os_disk_type      = &quot;Premium_LRS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tamanho do disco de dados adicional em GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_disk_size_gb = 64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO DE REDE ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CIDR da Virtual Network - range privado para toda a infraestrutura</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vnet_address_space        = &quot;10.0.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subnet para servidores web - onde ficam as VMs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web_subnet_address_prefix = &quot;10.0.1.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subnet para banco de dados - isolamento de rede</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_subnet_address_prefix  = &quot;10.0.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Range de IPs permitidos para SSH - &quot;*&quot; permite qualquer IP (cuidado em prod!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh_source_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista de CIDRs permitidos para SSH - alternativa mais granular</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowed_ssh_cidrs = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;0.0.0.0/0&quot; # Substitua pelo seu IP ou range corporativo para maior segurança</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Exemplos de uso em produção:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # &quot;201.123.45.0/24&quot;,  # Range corporativo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # &quot;10.0.0.0/8&quot;        # Rede interna VPN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO DA IMAGEM DA VM ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Imagem Ubuntu 20.04 LTS - estável e amplamente suportada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_image = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  publisher = &quot;Canonical&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  offer     = &quot;0001-com-ubuntu-server-focal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku       = &quot;20_04-lts-gen2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version   = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÕES OPCIONAIS ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Habilitar backup das VMs - importante para dados críticos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_backup         = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Período de retenção dos backups em dias</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_retention_days = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Habilitar monitoring com Log Analytics - recomendado para observabilidade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_monitoring     = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO DE AUTO-SHUTDOWN ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Horário para desligar VMs automaticamente (formato 24h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_time     = &quot;1900&quot; # 19:00 - economiza custos em ambiente de desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Timezone para o auto-shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_timezone = &quot;E. South America Standard Time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Email para receber notificações de shutdown (opcional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Deixe vazio (&quot;&quot;) se não quiser receber notificações</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notification_email = &quot;&quot; # Exemplo: &quot;admin@empresa.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === TAGS PERSONALIZADAS ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tags aplicadas a todos os recursos para organização e billing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Owner      = &quot;DevOps Team&quot;           # Responsável pelos recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CostCenter = &quot;TI-Infraestrutura&quot;    # Centro de custo para billing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Project    = &quot;Projeto Final Terraform&quot;  # Nome do projeto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Course     = &quot;Udemy Terraform&quot;      # Referência ao curso</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Student    = &quot;Seu Nome Aqui&quot;        # Personalize com seu nome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Purpose    = &quot;Learning&quot;             # Propósito dos recursos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Department = &quot;Engineering&quot;          # Departamento responsável</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="devtfvars">dev.tfvars<a href="#devtfvars" class="hash-link" aria-label="Direct link to dev.tfvars" title="Direct link to dev.tfvars">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># dev.tfvars - Configuração específica para ambiente de desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Otimizada para custos baixos e flexibilidade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === IDENTIFICAÇÃO DO AMBIENTE ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project_name = &quot;webapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment  = &quot;dev&quot;      # Ambiente de desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location     = &quot;Brazil South&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO ECONÔMICA PARA DEV ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Uma VM pequena é suficiente para desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_count          = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_size           = &quot;Standard_B1s&quot;    # VM mais barata disponível</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_username    = &quot;azureuser&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Discos mais baratos para desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os_disk_type      = &quot;Standard_LRS&quot;    # HDD padrão (mais barato)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_disk_size_gb = 32               # Disco menor para economizar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === REDE SIMPLIFICADA ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Range de rede separado para desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vnet_address_space        = &quot;10.10.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web_subnet_address_prefix = &quot;10.10.1.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_subnet_address_prefix  = &quot;10.10.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === SEGURANÇA RELAXADA PARA DEV ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Em desenvolvimento, permitimos acesso de qualquer IP para facilitar testes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh_source_address_prefix = &quot;*&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowed_ssh_cidrs         = [&quot;0.0.0.0/0&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === IMAGEM PADRÃO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ubuntu LTS para consistência entre ambientes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_image = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  publisher = &quot;Canonical&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  offer     = &quot;0001-com-ubuntu-server-focal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku       = &quot;20_04-lts-gen2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version   = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === FEATURES DESABILITADAS PARA ECONOMIA ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Em desenvolvimento, desabilitamos features caras</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_backup     = false    # Não fazemos backup em dev para economizar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_monitoring = false    # Monitoring desabilitado para reduzir custos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === AUTO-SHUTDOWN AGRESSIVO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Desliga VMs cedo para máxima economia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_time     = &quot;1800&quot; # 18:00 - mais cedo que outros ambientes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_timezone = &quot;E. South America Standard Time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Notificações desabilitadas em dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notification_email = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === TAGS DE DESENVOLVIMENTO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tags específicas para ambiente de desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Owner       = &quot;Developer&quot;        # Desenvolvedor responsável</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CostCenter  = &quot;R&amp;D&quot;             # Centro de pesquisa e desenvolvimento</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Environment = &quot;Development&quot;      # Identificação clara do ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AutoDelete  = &quot;true&quot;            # Indica que pode ser deletado automaticamente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Purpose     = &quot;Learning&quot;        # Propósito educacional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Course      = &quot;Terraform Udemy&quot; # Referência ao curso</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prodtfvars">prod.tfvars<a href="#prodtfvars" class="hash-link" aria-label="Direct link to prod.tfvars" title="Direct link to prod.tfvars">​</a></h2>
<div class="language-hcl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hcl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># prod.tfvars - Configuração específica para ambiente de produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Otimizada para performance, disponibilidade e segurança</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === IDENTIFICAÇÃO DO AMBIENTE ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">project_name = &quot;webapp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment  = &quot;prod&quot;     # Ambiente de produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location     = &quot;Brazil South&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO ROBUSTA PARA PRODUÇÃO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Múltiplas VMs para alta disponibilidade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_count          = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_size           = &quot;Standard_D2s_v3&quot;    # VM com boa performance (2 vCPUs, 8GB RAM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_username    = &quot;prodadmin&quot;          # Nome específico para produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Discos premium para máxima performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os_disk_type      = &quot;Premium_LRS&quot;        # SSD premium</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_disk_size_gb = 128                  # Disco maior para dados de produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === REDE SEGMENTADA ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Range de rede padrão para produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vnet_address_space        = &quot;10.0.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web_subnet_address_prefix = &quot;10.0.1.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db_subnet_address_prefix  = &quot;10.0.2.0/24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === SEGURANÇA RESTRITA ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># IMPORTANTE: Substitua pelos IPs reais da sua organização</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh_source_address_prefix = &quot;203.0.113.0/24&quot; # Exemplo de range corporativo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista de ranges permitidos para SSH em produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">allowed_ssh_cidrs = [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;203.0.113.0/24&quot;,    # Range corporativo principal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;198.51.100.0/24&quot;    # Range da VPN corporativa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Adicione outros ranges conforme necessário</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # Nunca use &quot;0.0.0.0/0&quot; em produção!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === IMAGEM PADRÃO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ubuntu LTS para estabilidade em produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vm_image = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  publisher = &quot;Canonical&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  offer     = &quot;0001-com-ubuntu-server-focal&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sku       = &quot;20_04-lts-gen2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  version   = &quot;latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === FEATURES COMPLETAS PARA PRODUÇÃO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Todos os recursos de proteção habilitados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_backup         = true      # Backup obrigatório em produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backup_retention_days = 90        # Retenção longa para compliance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enable_monitoring     = true      # Monitoring 24x7 obrigatório</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === AUTO-SHUTDOWN DESABILITADO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Produção não pode ser desligada automaticamente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_time     = &quot;0000&quot;   # Desabilitado (00:00 = sem shutdown)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auto_shutdown_timezone = &quot;E. South America Standard Time&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === TAGS DE PRODUÇÃO ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Tags específicas para ambiente de produção com informações críticas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Owner        = &quot;Operations Team&quot;   # Time de operações responsável</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CostCenter   = &quot;Production&quot;        # Centro de custo de produção</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Environment  = &quot;Production&quot;        # Identificação crítica do ambiente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Criticality  = &quot;High&quot;             # Criticidade alta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BackupPolicy = &quot;Daily&quot;            # Política de backup diário</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Monitoring   = &quot;24x7&quot;             # Monitoramento contínuo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Compliance   = &quot;Required&quot;         # Compliance obrigatório</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DataClass    = &quot;Confidential&quot;     # Classificação dos dados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="comandos-de-execução">Comandos de Execução<a href="#comandos-de-execução" class="hash-link" aria-label="Direct link to Comandos de Execução" title="Direct link to Comandos de Execução">​</a></h2>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># === CONFIGURAÇÃO INICIAL DO AZURE ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Login no Azure e configuração da subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az account list --output table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az account set --subscription &quot;sua-subscription-id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az account show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Exportar variável de ambiente para subscription (opcional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ARM_SUBSCRIPTION_ID=&quot;sua-subscription-id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === INICIALIZAÇÃO DO TERRAFORM ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Inicializa o projeto, baixa providers e configura backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Valida sintaxe e configuração dos arquivos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform validate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Formata código para manter padrão consistente</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === DEPLOYMENT POR AMBIENTE ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Desenvolvimento - recursos mínimos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan -var-file=&quot;dev.tfvars&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply -var-file=&quot;dev.tfvars&quot; -auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Produção - recursos completos (cuidado!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform plan -var-file=&quot;prod.tfvars&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform apply -var-file=&quot;prod.tfvars&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === VERIFICAÇÃO DOS RECURSOS ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Mostra todos os outputs definidos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista recursos criados no Azure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az resource list --resource-group $(terraform output -raw resource_group_name) --output table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Lista específica de VMs criadas</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az vm list --resource-group $(terraform output -raw resource_group_name) --output table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === TESTE DE CONECTIVIDADE SSH ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Obtém IP público da primeira VM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VM_IP=$(az network public-ip show \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --resource-group $(terraform output -raw resource_group_name) \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name webapp-dev-pip-1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --query ipAddress -o tsv)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Salva chave SSH privada para conexão</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform output -raw ssh_private_key_pem &gt; private_key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chmod 600 private_key.pem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Conecta à VM via SSH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i private_key.pem azureuser@$VM_IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === TESTES DENTRO DA VM ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Verifica informações do sistema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uname -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df -h        # Espaço em disco</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lsblk        # Lista discos anexados</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Instala e testa nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt install -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl start nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl enable nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl localhost   # Testa servidor web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === MONITORAMENTO DE CUSTOS ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Verifica uso atual da subscription</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az consumption usage list --output table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Monitora custos no portal (abrir em navegador)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Monitorar custos em: https://portal.azure.com/#blade/Microsoft_Azure_CostManagement/Menu/overview&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># === LIMPEZA DOS RECURSOS ===</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># CUIDADO: Remove toda a infraestrutura criada</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terraform destroy -var-file=&quot;dev.tfvars&quot; -auto-approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Verifica se resource groups foram removidos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">az group list --output table</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resumo-das-funcionalidades-demonstradas">Resumo das Funcionalidades Demonstradas<a href="#resumo-das-funcionalidades-demonstradas" class="hash-link" aria-label="Direct link to Resumo das Funcionalidades Demonstradas" title="Direct link to Resumo das Funcionalidades Demonstradas">​</a></h2>
<p>Este laboratório final demonstra uso <strong>avançado</strong> do Terraform com:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-variables-e-validação">✅ <strong>Variables e Validação</strong><a href="#-variables-e-validação" class="hash-link" aria-label="Direct link to -variables-e-validação" title="Direct link to -variables-e-validação">​</a></h3>
<ul>
<li>Variables tipadas (string, number, bool, object, list)</li>
<li>Validação com regex, contains(), range checks</li>
<li>Objetos complexos para configuração de imagens</li>
<li>Validação de CIDRs e emails</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-locals-e-lógica-complexa">✅ <strong>Locals e Lógica Complexa</strong><a href="#-locals-e-lógica-complexa" class="hash-link" aria-label="Direct link to -locals-e-lógica-complexa" title="Direct link to -locals-e-lógica-complexa">​</a></h3>
<ul>
<li>Naming conventions centralizadas</li>
<li>Configuração condicional por ambiente</li>
<li>Maps de objetos para configurações</li>
<li>For expressions para listas dinâmicas</li>
<li>Merge de tags padrão com personalizadas</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-outputs-informativos">✅ <strong>Outputs Informativos</strong><a href="#-outputs-informativos" class="hash-link" aria-label="Direct link to -outputs-informativos" title="Direct link to -outputs-informativos">​</a></h3>
<ul>
<li>Informações de recursos criados</li>
<li>Comandos SSH prontos para uso</li>
<li>Dados para estimativa de custos</li>
<li>Resumo completo do deployment</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-count-e-for-expressions">✅ <strong>Count e For Expressions</strong><a href="#-count-e-for-expressions" class="hash-link" aria-label="Direct link to -count-e-for-expressions" title="Direct link to -count-e-for-expressions">​</a></h3>
<ul>
<li>Múltiplas VMs com count</li>
<li>Public IPs dinâmicos</li>
<li>Regras de segurança geradas dinamicamente</li>
<li>Resources attachments em loop</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-providers-múltiplos">✅ <strong>Providers Múltiplos</strong><a href="#-providers-múltiplos" class="hash-link" aria-label="Direct link to -providers-múltiplos" title="Direct link to -providers-múltiplos">​</a></h3>
<ul>
<li><strong>azurerm</strong>: Recursos do Azure</li>
<li><strong>random</strong>: IDs únicos para storage</li>
<li><strong>tls</strong>: Geração automática de chaves SSH</li>
<li><strong>time</strong>: Timestamps e delays</li>
<li><strong>null</strong>: Triggers e dependências</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-recursos-condicionais">✅ <strong>Recursos Condicionais</strong><a href="#-recursos-condicionais" class="hash-link" aria-label="Direct link to -recursos-condicionais" title="Direct link to -recursos-condicionais">​</a></h3>
<ul>
<li>Load Balancer só com múltiplas VMs</li>
<li>Backup baseado em flags</li>
<li>Monitoring condicional</li>
<li>Auto-shutdown por ambiente</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-data-sources">✅ <strong>Data Sources</strong><a href="#-data-sources" class="hash-link" aria-label="Direct link to -data-sources" title="Direct link to -data-sources">​</a></h3>
<ul>
<li>Azure client config automático</li>
<li>Informações da sessão atual</li>
<li>Tenant e subscription IDs</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-funcionalidades-de-produção">✅ <strong>Funcionalidades de Produção</strong><a href="#-funcionalidades-de-produção" class="hash-link" aria-label="Direct link to -funcionalidades-de-produção" title="Direct link to -funcionalidades-de-produção">​</a></h3>
<ul>
<li>Key Vault para secrets</li>
<li>Network Security Groups</li>
<li>Managed Disks separados</li>
<li>Boot diagnostics</li>
<li>Auto-shutdown para economia</li>
<li>Tags organizacionais completas</li>
<li>Backup policies</li>
<li>Log Analytics e monitoring</li>
<li>Application Security Groups</li>
<li>Private DNS zones</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-estimativa-de-custos">💰 <strong>Estimativa de Custos</strong><a href="#-estimativa-de-custos" class="hash-link" aria-label="Direct link to -estimativa-de-custos" title="Direct link to -estimativa-de-custos">​</a></h3>
<ul>
<li><strong>Desenvolvimento</strong>: ~$8-15 USD/mês (com auto-shutdown)</li>
<li><strong>Produção</strong>: ~$390-515 USD/mês (3 VMs, backup completo, monitoring)</li>
</ul>
<p>Este é um <strong>projeto de portfólio</strong> que demonstra domínio profissional do Terraform para Infrastructure as Code em ambiente empresarial.</p>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"></code></pre></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#versionstf" class="table-of-contents__link toc-highlight">versions.tf</a></li><li><a href="#maintf" class="table-of-contents__link toc-highlight">main.tf</a></li><li><a href="#additional-resourcestf" class="table-of-contents__link toc-highlight">additional-resources.tf</a></li><li><a href="#variablestf" class="table-of-contents__link toc-highlight">variables.tf</a></li><li><a href="#localstf" class="table-of-contents__link toc-highlight">locals.tf</a></li><li><a href="#outputstf" class="table-of-contents__link toc-highlight">outputs.tf</a></li><li><a href="#terraformtfvars" class="table-of-contents__link toc-highlight">terraform.tfvars</a></li><li><a href="#devtfvars" class="table-of-contents__link toc-highlight">dev.tfvars</a></li><li><a href="#prodtfvars" class="table-of-contents__link toc-highlight">prod.tfvars</a></li><li><a href="#comandos-de-execução" class="table-of-contents__link toc-highlight">Comandos de Execução</a></li><li><a href="#resumo-das-funcionalidades-demonstradas" class="table-of-contents__link toc-highlight">Resumo das Funcionalidades Demonstradas</a><ul><li><a href="#-variables-e-validação" class="table-of-contents__link toc-highlight">✅ <strong>Variables e Validação</strong></a></li><li><a href="#-locals-e-lógica-complexa" class="table-of-contents__link toc-highlight">✅ <strong>Locals e Lógica Complexa</strong></a></li><li><a href="#-outputs-informativos" class="table-of-contents__link toc-highlight">✅ <strong>Outputs Informativos</strong></a></li><li><a href="#-count-e-for-expressions" class="table-of-contents__link toc-highlight">✅ <strong>Count e For Expressions</strong></a></li><li><a href="#-providers-múltiplos" class="table-of-contents__link toc-highlight">✅ <strong>Providers Múltiplos</strong></a></li><li><a href="#-recursos-condicionais" class="table-of-contents__link toc-highlight">✅ <strong>Recursos Condicionais</strong></a></li><li><a href="#-data-sources" class="table-of-contents__link toc-highlight">✅ <strong>Data Sources</strong></a></li><li><a href="#-funcionalidades-de-produção" class="table-of-contents__link toc-highlight">✅ <strong>Funcionalidades de Produção</strong></a></li><li><a href="#-estimativa-de-custos" class="table-of-contents__link toc-highlight">💰 <strong>Estimativa de Custos</strong></a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer_fXop"><div class="container_yNGW"><div><img src="/img/devops-logo.png" alt="Logo" class="logo_yP8X"><p class="follow_o8qg">Siga nas redes</p><ul class="socialList_o9Gv"><li><a href="https://www.youtube.com/channel/UCxRNzCKgqQ0FW0GKuRSjlEQ" target="_blank" rel="noopener noreferrer"><img src="/img/logos_youtube-icon.avif" alt="YouTube"><span>iesodias</span></a></li><li><a href="https://linkedin.com/in/iesodias" target="_blank" rel="noopener noreferrer"><img src="/img/devicon_linkedin.avif" alt="LinkedIn"><span>iesodias</span></a></li><li><a href="https://instagram.com/iesofdias" target="_blank" rel="noopener noreferrer"><img src="/img/skill-icons_instagram.avif" alt="Instagram"><span>iesofdias</span></a></li></ul></div><div><p class="newsletterTitle_Ceq2">Dúvidas?</p><p class="email_nAjm">Fale Comigo <br><a href="mailto:iesodias@gmail.com">iesodias@gmail.com</a></p></div><div><p class="sectionTitle_mBm8">Links rápidos</p><ul class="linkList_pzh5"><li><a href="#">Github</a></li><li><a href="#">Youtube</a></li><li><a href="#">Blog</a></li></ul></div><div><p class="sectionTitle_mBm8">Legal</p><ul class="linkList_pzh5"><li><a href="#">Termos</a></li><li><a href="#">Privacidade</a></li></ul></div></div></footer></div>
</body>
</html>